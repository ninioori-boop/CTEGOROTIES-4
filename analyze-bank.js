module.exports = async (req, res) => {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { text, bankName } = req.body || {};

  if (!text) {
    return res.status(400).json({ error: 'No text provided' });
  }

  const API_KEY = process.env.OPENAI_API_KEY;

  if (!API_KEY) {
    return res.status(500).json({ error: 'API key not configured on server' });
  }

  // ×”×’×‘×œ×ª ××•×¨×š ×”×˜×§×¡×˜
  const cleanText = text.substring(0, 20000);

  const systemMessage = `××ª×” ×× ×ª×— ×“×¤×™ ×—×©×‘×•×Ÿ ×¢×•"×© ×™×©×¨××œ×™. ×”×—×–×¨ JSON: {"expenses":[{"description":"×©×","amount":123,"category":"×§×˜×’×•×¨×™×”"}]}

â›” ×”×ª×¢×œ× ×œ×’××¨×™ × (××œ×” ×œ× ×”×•×¦××•×ª!):
- ×ª×©×œ×•××™ ×›×¨×˜×™×¡ ××©×¨××™: ××§×¡ ××™×˜, MAX, ×™×©×¨××›×¨×˜, ×›××œ, ×œ××•××™ ×§××¨×“, ×“×™×™× ×¨×¡, ×•×™×–×” CAL
- ×”×›× ×¡×•×ª: ××›×™×¨×”/, ×¨×™×‘×™×ª ×–×›×•×ª, ××™×œ×•××™×, ××©×›×•×¨×ª, ×–×™×›×•×™, ×”×¤×§×“×”, ×”×¢×‘×¨×” ××—×©×‘×•×Ÿ
- ×”×©×§×¢×•×ª: ×§× ×™×”/, ××›×™×¨×”/, ××œ×˜×©×•×œ×¨, ××’×“×œ ×§×¨× ×•×ª, ××§×¡×œ× ×¡, ××™×˜×‘, ×§×¨×Ÿ ×›×¡×¤×™×ª, IBI
- ×”××¨×•×ª ××˜×—: ×§×™×–×•×– ××˜×—, ××˜"×—, ×”××¨×”, ×¤×§×“×•×Ÿ
- ××™×¡×™× ×¢×œ ×¨×•×•×—×™×: ××¡ ×‘×’×™×Ÿ ×¨×™×‘×™×ª, ×ª× ×•×¢×ª ××¡, × ×™×›×•×™ ××¡
- ×™×ª×¨×•×ª ×•×¡×™×›×•××™×: ×™×ª×¨×”, ×¡×”"×›, ×¡×™×›×•×, ×¤×ª×™×—×”
- ×›×œ ×©×•×¨×” ×¢× ×¡×›×•× ×‘×¢××•×“×ª "×–×›×•×ª" = ×”×›× ×¡×”!

âœ… ×—×œ×¥ ×¨×§ ×”×•×¦××•×ª ×××™×ª×™×•×ª:
- ×§×•×¤×•×ª ×—×•×œ×™×: ××›×‘×™ ×©×™×¨×•×ª×™ ×‘×¨×™××•×ª, ×›×œ×œ×™×ª, ×××•×—×“×ª, ×œ××•××™×ª
- ×—×©××œ: ×—×‘×¨×ª ×”×—×©××œ, ×¡×•×¤×¨-×¤××•×•×¨, ×‘×–×§ ×× ×¨×’×™×”
- ××™×: ××™ ××‘×™×‘×™×, ×”×’×™×—×•×Ÿ, ××™ ×›×¨××œ, ××™ ×’×ª, ××™ × ×ª× ×™×”, ××™ ×”×¨×¦×œ×™×”, ×¤×œ×’ ×”×’×œ×™×œ
- ×’×–: ×¤×–×’×–, ×¡×•×¤×¨×’×–, ×××™×©×¨××’×–, ×“×•×¨×’×–
- ××¨× ×•× ×”: ×¢×™×¨×™×™×ª..., ××¨× ×•× ×”
- ×“×™×•×¨: ×©×›×¨ ×“×™×¨×”, ××©×›× ×ª×, ×“×™×¨×” ×œ×”×©×›×™×¨, ×¢××™×“×¨
- × ×™×”×•×œ ×‘× ×™×™×Ÿ: ×•×¢×“ ×‘×™×ª, ××™×™ ×˜××•×•×¨, ××“×Ÿ × ×™×”×•×œ, ×§×œ×™× ×˜×•×Ÿ
- ×‘×™×˜×•×—: ×‘×™×˜×•×— ×œ××•××™, ×”×¨××œ, ××’×“×œ, ×”×¤× ×™×§×¡, ×›×œ×œ, ×× ×•×¨×”, ××™×™×œ×•×Ÿ
- ×”×œ×•×•××•×ª: ××™××•×Ÿ ×™×©×™×¨, ×‘×œ× ×“×¨, ×˜×¨×™×, ×”×—×–×¨ ×”×œ×•×•××”
- ××–×•××Ÿ: ××©×™×›×ª ××–×•××Ÿ, ××©×™×›×” ×‘×›×¡×¤×•××˜
- ×‘×™×˜: ×”×¢×‘×¨×” ×‘×‘×™×˜, BIT
- ×ª×¨×•××•×ª: ×™×“ ×©×¨×”, ×œ×ª×ª, ×¢×–×¨ ××¦×™×•×Ÿ, ××“"×, ×–×§"×

×§×˜×’×•×¨×™×•×ª ×–××™× ×•×ª:
×§×•×¤×ª ×—×•×œ×™×, ×—×©××œ, ×’×–, ××™× ×•×‘×™×•×‘, ××¨× ×•× ×”, ×©×›×¨ ×“×™×¨×”, ××©×›× ×ª×, ×“××™ × ×™×”×•×œ ×‘× ×™×™×Ÿ, ×‘×™×˜×•×— ×œ××•××™, ×‘×™×˜×•×—, ×”×—×–×¨ ×”×œ×•×•××•×ª, ××–×•××Ÿ ×œ×œ× ××¢×§×‘, ×ª×¨×•××•×ª, ×¢××œ×•×ª ×‘× ×§ ×•××©×¨××™, ×‘×™×˜ ×œ×œ× ××¢×§×‘, ×—×™× ×•×š ×•×§×™×™×˜× ×•×ª, ×©×•× ×•×ª

×“×•×’×××•×ª ×œ×§×˜×’×•×¨×™×–×¦×™×” × ×›×•× ×”:
âœ… "××›×‘×™ ×©×™×¨×•×ª×™ ×‘×¨×™××•×ª 309" â†’ ×§×•×¤×ª ×—×•×œ×™×
âœ… "×©×™×¨×•×ª×™ ×‘×¨×™××•×ª ×›×œ×œ×™×ª 250" â†’ ×§×•×¤×ª ×—×•×œ×™×
âœ… "×—×‘×¨×ª ×”×—×©××œ 450" â†’ ×—×©××œ
âœ… "××™ ××‘×™×‘×™× 120" â†’ ××™× ×•×‘×™×•×‘
âœ… "×”×’×™×—×•×Ÿ 95" â†’ ××™× ×•×‘×™×•×‘
âœ… "×¤×–×’×– 85" â†’ ×’×–
âœ… "×¡×•×¤×¨×’×– 70" â†’ ×’×–
âœ… "××¨× ×•× ×” ×¢×™×¨×™×™×ª ×ª×œ ××‘×™×‘ 890" â†’ ××¨× ×•× ×”
âœ… "×¢×™×¨×™×™×ª ×™×¨×•×©×œ×™× 750" â†’ ××¨× ×•× ×”
âœ… "×‘×™×˜×•×— ×œ××•××™ 904" â†’ ×‘×™×˜×•×— ×œ××•××™
âœ… "×”×¨××œ ×‘×™×˜×•×— 350" â†’ ×‘×™×˜×•×—
âœ… "××©×™×›×ª ××–×•××Ÿ 500" â†’ ××–×•××Ÿ ×œ×œ× ××¢×§×‘
âœ… "×”×¢×‘×¨×” ×‘×‘×™×˜ 300" â†’ ×‘×™×˜ ×œ×œ× ××¢×§×‘
âœ… "×•×¢×“ ×‘×™×ª 350" â†’ ×“××™ × ×™×”×•×œ ×‘× ×™×™×Ÿ
âœ… "××™×™ ×˜××•×•×¨ 472" â†’ ×“××™ × ×™×”×•×œ ×‘× ×™×™×Ÿ
âœ… "×™×“ ×©×¨×” 100" â†’ ×ª×¨×•××•×ª
âœ… "×¢××œ×ª × ×™×”×•×œ 25" â†’ ×¢××œ×•×ª ×‘× ×§ ×•××©×¨××™

âŒ "××§×¡ ××™×˜ ×¤×™× × ×¡×™× 3500" â†’ ×”×ª×¢×œ×
âŒ "×§× ×™×”/××œ×˜×©×•×œ×¨ 15000" â†’ ×”×ª×¢×œ×
âŒ "××›×™×¨×”/×§×¨×Ÿ ×›×¡×¤×™×ª 5000" â†’ ×”×ª×¢×œ×
âŒ "×¨×™×‘×™×ª ×–×›×•×ª 45" â†’ ×”×ª×¢×œ×
âŒ "××©×›×•×¨×ª 12000" â†’ ×”×ª×¢×œ×
âŒ "×”×¤×§×“×” 5000" â†’ ×”×ª×¢×œ×

×—×©×•×‘: ×× ××™×Ÿ ×”×•×¦××•×ª ×××™×ª×™×•×ª, ×”×—×–×¨ {"expenses":[]}`;

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemMessage },
          { role: 'user', content: cleanText }
        ],
        max_tokens: 8000,
        temperature: 0.1,
        response_format: { type: "json_object" }
      })
    });

    if (!response.ok) {
      const err = await response.json();
      console.error('OpenAI Error:', err);
      return res.status(500).json({ error: err.error?.message || 'OpenAI error' });
    }

    const data = await response.json();
    const content = data.choices[0].message.content;

    try {
      let result = JSON.parse(content);
      
      // ×¡×™× ×•×Ÿ × ×•×¡×£ ××—×¨×™ AI
      if (result.expenses && Array.isArray(result.expenses)) {
        const ignorePatterns = [
          // ×ª×©×œ×•××™ ××©×¨××™
          '××§×¡', 'max', '×™×©×¨××›×¨×˜', '×›××œ', '×œ××•××™ ×§××¨×“', '×“×™×™× ×¨×¡', '×•×™×–×”', 'visa',
          // ×”×©×§×¢×•×ª
          '×§× ×™×”/', '××›×™×¨×”/', '××œ×˜×©×•×œ×¨', '××’×“×œ ×§×¨× ×•×ª', '××§×¡×œ× ×¡', '××™×˜×‘', 'ibi',
          '×§×¨×Ÿ ×›×¡×¤×™×ª', '×¤×§×“×•×Ÿ', '×ª×¢×•×“×ª ×¡×œ', '×§×¨×Ÿ × ××× ×•×ª',
          // ×”×›× ×¡×•×ª
          '×¨×™×‘×™×ª ×–×›×•×ª', '××™×œ×•××™×', '××©×›×•×¨×ª', '×–×™×›×•×™', '×”×—×–×¨', '×”×¢×‘×¨×” ××—×©×‘×•×Ÿ',
          // ××™×¡×™× ×¢×œ ×¨×•×•×—×™×
          '×§×™×–×•×–', '××˜"×—', '×”××¨×”', '××¡ ×‘×’×™×Ÿ', '×ª× ×•×¢×ª ××¡', '× ×™×›×•×™ ××¡',
          // ×™×ª×¨×•×ª
          '×™×ª×¨×”', '×¡×”"×›', '×¡×™×›×•×', '×”×¤×§×“×”', '×”×¢×‘×¨×” ×œ×—×©×‘×•×Ÿ', '×¤×ª×™×—×”', '×¡×’×™×¨×”'
        ];
        
        result.expenses = result.expenses.filter(exp => {
          if (!exp || !exp.description) return false;
          
          const desc = exp.description.toLowerCase();
          const shouldIgnore = ignorePatterns.some(pattern => 
            desc.includes(pattern.toLowerCase())
          );
          
          // ×¡× ×Ÿ ×’× ×¡×›×•××™× ×’×‘×•×”×™× ×××•×“ ×©×›× ×¨××” ×”× ×œ× ×”×•×¦××•×ª ×¨×’×™×œ×•×ª
          if (exp.amount > 5000 && 
              !['××©×›× ×ª×', '×©×›×¨ ×“×™×¨×”', '×‘×™×˜×•×— ×œ××•××™'].includes(exp.category)) {
            console.log(`âš ï¸ ×¡×™× ×•×Ÿ ×¡×›×•× ×’×‘×•×”: ${exp.description} - ${exp.amount}`);
            return false;
          }
          
          if (shouldIgnore) {
            console.log(`ğŸš« ×¡×™× ×•×Ÿ ××—×¨×™ AI: ${exp.description}`);
            return false;
          }
          
          return true;
        });
      }
      
      return res.status(200).json(result);
    } catch (parseError) {
      // × ×¡×” ×œ×—×œ×¥ JSON ××”×ª×©×•×‘×”
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);
        return res.status(200).json(result);
      }
      return res.status(500).json({ error: 'Invalid AI response format' });
    }

  } catch (error) {
    console.error('Server Error:', error);
    return res.status(500).json({ error: error.message });
  }
};
