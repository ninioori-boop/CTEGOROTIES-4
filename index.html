<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>המקטרג - השקעות לצעירים בתכלס</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');

    :root {
      --blue-dark: #1a365d;
      --blue-medium: #2c5282;
      --blue-light: #3182ce;
      --white: #ffffff;
      --white-soft: #f7fafc;
      --black: #1a202c;
      --gray: #718096;
      --green: #38a169;
      --red: #e53e3e;
      --orange: #dd6b20;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-medium) 100%);
      min-height: 100vh;
      color: var(--black);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      padding: 2rem 0;
      color: var(--white);
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .main-card {
      background: var(--white);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--blue-dark);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .btn {
      background: linear-gradient(135deg, var(--blue-light) 0%, var(--blue-medium) 100%);
      color: var(--white);
      border: none;
      padding: 1.2rem 3rem;
      font-size: 1.2rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Heebo', sans-serif;
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(49, 130, 206, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-green {
      background: linear-gradient(135deg, var(--green) 0%, #276749 100%);
    }

    .btn-green:hover {
      box-shadow: 0 10px 30px rgba(56, 161, 105, 0.4);
    }

    .upload-section {
      margin-bottom: 2rem;
    }

    .upload-section h3 {
      color: var(--blue-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .upload-box {
      border: 3px dashed #cbd5e0;
      border-radius: 15px;
      padding: 2rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--white-soft);
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .upload-box:hover {
      border-color: var(--blue-light);
      background: #ebf8ff;
    }

    .upload-box.has-file {
      border-color: var(--green);
      background: #f0fff4;
    }

    .upload-box .icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .upload-box h4 {
      color: var(--blue-dark);
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .upload-box p {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .upload-box input[type="file"] {
      display: none;
    }

    .add-card-btn {
      border: 3px dashed #cbd5e0;
      border-radius: 15px;
      padding: 2rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--white-soft);
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .add-card-btn:hover {
      border-color: var(--blue-light);
      background: #ebf8ff;
    }

    .add-card-btn .icon {
      font-size: 2.5rem;
      color: var(--blue-light);
    }

    .files-list {
      background: #f7fafc;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-item .name {
      color: var(--blue-dark);
      font-weight: 500;
    }

    .file-item .status {
      color: var(--green);
      font-size: 0.9rem;
    }

    .remove-btn {
      background: var(--red);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 54, 93, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--white);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--white);
      font-size: 1.5rem;
      margin-top: 2rem;
      text-align: center;
    }

    .loading-subtext {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.1rem;
      margin-top: 0.5rem;
    }

    .error-message {
      background: #fed7d7;
      border: 2px solid #fc8181;
      color: #c53030;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: none;
      text-align: center;
    }

    .error-message.active {
      display: block;
    }

    .success-message {
      background: #c6f6d5;
      border: 2px solid #68d391;
      color: #276749;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: none;
      text-align: center;
    }

    .success-message.active {
      display: block;
    }

    .instructions {
      background: #ebf8ff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .instructions p {
      color: var(--blue-dark);
      font-size: 1.1rem;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--white);
      opacity: 0.8;
    }

    .divider {
      height: 2px;
      background: linear-gradient(to right, transparent, #e2e8f0, transparent);
      margin: 2rem 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      header h1 {
        font-size: 2rem;
      }

      .main-card {
        padding: 1.5rem;
      }

      .upload-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">מנתח את הדוחות...</div>
    <div class="loading-subtext" id="loadingSubtext">ChatGPT מקטלג את ההוצאות</div>
  </div>

  <div class="container">
    <header>
      <h1>המקטרג</h1>
      <p>השקעות לצעירים בתכלס</p>
    </header>

    <div class="main-card">
      <div class="instructions">
        <p>העלה קבצי Excel/CSV של דוחות הוצאות והמערכת תנתח ותקטלג אותם אוטומטית</p>
      </div>

      <!-- Credit Cards Section -->
      <div class="upload-section">
        <h3>💳 כרטיסי אשראי (Excel/CSV)</h3>
        <div class="upload-grid" id="creditCardsGrid">
          <div class="upload-box" id="cardBox1" onclick="console.log('Click card 1'); document.getElementById('cardInput1').click();">
            <div class="icon" id="cardIcon1">📄</div>
            <h4 id="cardTitle1">כרטיס אשראי 1</h4>
            <p id="cardDesc1">לחץ לבחירת קובץ</p>
            <input type="file" id="cardInput1" accept=".xlsx,.xls,.csv" onchange="handleCardFile(1, this)">
          </div>
          <div class="add-card-btn" onclick="console.log('Add card clicked'); addCardSlot();">
            <div class="icon">➕</div>
            <h4>הוסף כרטיס</h4>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Bank Account Section -->
      <div class="upload-section">
        <h3>🏦 חשבון עו"ש (Excel/CSV)</h3>
        <div class="upload-grid">
          <div class="upload-box" id="bankBox" onclick="console.log('Click bank'); document.getElementById('bankInput').click();">
            <div class="icon" id="bankIcon">📄</div>
            <h4 id="bankTitle">דוח תנועות עו"ש</h4>
            <p id="bankDesc">לחץ לבחירת קובץ Excel/CSV</p>
            <input type="file" id="bankInput" accept=".xlsx,.xls,.csv" onchange="handleBankFile(this)">
          </div>
        </div>
      </div>

      <div class="success-message" id="successMessage"></div>
      <div class="error-message" id="errorMessage"></div>

      <button class="btn btn-green" onclick="analyzeAllCards()" id="analyzeBtn" disabled>
        נתח את כל הדוחות
      </button>
    </div>

    <footer>
      <p>אורי ניניו</p>
    </footer>
  </div>

  <script>
    // ===== בדיקת טעינת הדף והספריות =====
    console.log('🔄 Script starting...');
    console.log('🔍 DEBUG VERSION: 2026-01-30-v3 - JavaScript fix');
    
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('❌ JavaScript Error:', msg, 'at line', lineNo);
      alert('שגיאת JavaScript: ' + msg);
      return false;
    };
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📄 Page loaded successfully');
      
      // בדיקה שספריית XLSX נטענה
      if (typeof XLSX === 'undefined') {
        console.error('❌ XLSX library not loaded!');
        document.getElementById('errorMessage').textContent = 'שגיאה: ספריית Excel לא נטענה. נסה לרענן את הדף (Ctrl+F5).';
        document.getElementById('errorMessage').classList.add('active');
      } else {
        console.log('✅ XLSX library loaded successfully');
      }
      
      // בדיקה שהאלמנטים קיימים
      const cardInput = document.getElementById('cardInput1');
      const bankInput = document.getElementById('bankInput');
      console.log('📋 cardInput1 exists:', !!cardInput);
      console.log('📋 bankInput exists:', !!bankInput);
    });

    // ===== מאגר עסקים ישראלי MEGA - 1000+ עסקים =====
    const BUSINESS_DATABASE = {
      // ========== עדיפות עליונה - חייב להיבדק ראשון! ==========
      'נציבות מס הכנסה': 'מיסים', 'נציבות מס': 'מיסים', 'מס הכנסה ומיסים': 'מיסים',
      'ביטוח לאומי ספק': 'ביטוח לאומי', 'ביטוח לאומי הוק': 'ביטוח לאומי', 
      'ביטוח לאומי': 'ביטוח לאומי', 'בטל': 'ביטוח לאומי',
      'דמי כרטיס': 'עמלות בנק ואשראי', 'עמלת כרטיס': 'עמלות בנק ואשראי',
      'מ.תחבורה': 'תחבצ', 'פנגו מוביט': 'תחבצ', 'מ.תחבורה - פנגו': 'תחבצ',
      'מ.התחבורה': 'תחבצ', 'מ.תחבורה ?': 'תחבצ',
      'דן חברה לתחבורה': 'תחבצ', 'דן תחבורה': 'תחבצ',
      'משרד התחבורה-אגרה': 'כבישי אגרה', 'משרד התחבורה': 'כבישי אגרה',
      'פרי טיוי': 'תקשורת', 'פרי טיוי פלוס': 'תקשורת',

      // ========== ביטוחים (30+) ==========
      'הראל': 'ביטוח', 'harel': 'ביטוח', 'הראל בריאות': 'ביטוח', 'הראל ביטוח': 'ביטוח',
      'הראל חיים': 'ביטוח', 'הראל (שלוח)': 'ביטוח', 'מגדל': 'ביטוח', 'migdal': 'ביטוח',
      'מגדל ביטוח': 'ביטוח', 'הפניקס': 'ביטוח', 'phoenix': 'ביטוח', 'פניקס': 'ביטוח',
      'כלל ביטוח': 'ביטוח', 'clal': 'ביטוח', 'מנורה': 'ביטוח', 'מנורה מבטחים': 'ביטוח',
      'איילון': 'ביטוח', 'ayalon': 'ביטוח', 'ביטוח ישיר': 'ביטוח', 'idi': 'ביטוח',
      'aig': 'ביטוח', 'שלמה ביטוח': 'ביטוח', 'שומרה': 'ביטוח', 'ליברה': 'ביטוח',
      'libra': 'ביטוח', 'wesure': 'ביטוח', 'וויסור': 'ביטוח', 'פספורטכארד': 'ביטוח',
      'passportcard': 'ביטוח', 'ביטוח חקלאי': 'ביטוח', 'הכשרה': 'ביטוח',

      // ========== קופות חולים ==========
      'מכבי שירותי': 'קופת חולים', 'מכבי': 'קופת חולים', 'maccabi': 'קופת חולים',
      'כללית': 'קופת חולים', 'clalit': 'קופת חולים', 'שירותי בריאות כללית': 'קופת חולים',
      'מאוחדת': 'קופת חולים', 'meuhedet': 'קופת חולים', 'לאומית': 'קופת חולים',

      // ========== בריאות ושיניים (30+) ==========
      'מכבידנט': 'בריאות', 'maccabident': 'בריאות', 'דנטל': 'בריאות', 'dental': 'בריאות',
      'כללית סמייל': 'בריאות', 'clalit smile': 'בריאות', 'אסותא': 'בריאות', 'assuta': 'בריאות',
      'טרם': 'בריאות', 'terem': 'בריאות', 'ביקורופא': 'בריאות', 'שיבא': 'בריאות',
      'איכילוב': 'בריאות', 'הדסה': 'בריאות', 'רמב"ם': 'בריאות', 'שערי צדק': 'בריאות',
      'רופא': 'בריאות', 'מרפאה': 'בריאות', 'קליניקה': 'בריאות', 'אופטיקה': 'בריאות',
      'משקפיים': 'בריאות', 'הלפרין': 'בריאות', 'אמריקן לייזר': 'בריאות',
      'מדיקל סנטר': 'בריאות', 'בית בלב': 'בריאות', 'שיניים': 'בריאות',

      // ========== תקשורת ומנויים (50+) ==========
      'next tv': 'תקשורת', 'נקסט': 'תקשורת', 'hot mobile': 'תקשורת', 'hot': 'תקשורת',
      'הוט': 'תקשורת', 'hottelecom': 'תקשורת', 'bezeq': 'תקשורת', 'בזק': 'תקשורת',
      'partner': 'תקשורת', 'פרטנר': 'תקשורת', 'cellcom': 'תקשורת', 'סלקום': 'תקשורת',
      'pelephone': 'תקשורת', 'פלאפון': 'תקשורת', 'yes': 'תקשורת', 'יס': 'תקשורת',
      'sting tv': 'תקשורת', 'סטינג': 'תקשורת', 'netflix': 'תקשורת', 'נטפליקס': 'תקשורת',
      'spotify': 'תקשורת', 'spotifyil': 'תקשורת', 'apple music': 'תקשורת',
      'amazon prime': 'תקשורת', 'disney': 'תקשורת', 'דיסני': 'תקשורת',
      'youtube': 'תקשורת', 'google one': 'תקשורת', 'google cha': 'תקשורת',
      'google bus': 'תקשורת', '012': 'תקשורת', '013': 'תקשורת', '014': 'תקשורת',
      'ידיעות אחרונות': 'תקשורת', 'הארץ': 'תקשורת', 'גלובס': 'תקשורת', 'כלכליסט': 'תקשורת',
      'black phone': 'תקשורת',
      'מיכאליס': 'אוכל בחוץ ובילויים', 'michaelis': 'אוכל בחוץ ובילויים', 'apple.com/bill': 'תקשורת',

      // ========== ביט ומזומן ==========
      'העברה ב bit': 'ביט ללא מעקב', 'העברה בביט': 'ביט ללא מעקב', 
      'העברה ב-bit': 'ביט ללא מעקב', 'bit בנה"פ': 'ביט ללא מעקב',
      'bit': 'ביט ללא מעקב', 'paybox': 'ביט ללא מעקב',
      'משיכת מזומן': 'מזומן ללא מעקב', 'משיכה בכספומט': 'מזומן ללא מעקב',
      'כספומט': 'מזומן ללא מעקב', 'atm': 'מזומן ללא מעקב',

      // ========== סופרמרקטים ומזון לבית (40+) ==========
      'ngo deli': 'מזון לבית', 'ngo deli - apple pay': 'מזון לבית',
      'יאנגו דאלי': 'מזון לבית', 'yango deli': 'מזון לבית', 'yango daily': 'מזון לבית',
      'קיוסק מילנה': 'מזון לבית', 'קיוסק העצמאות': 'מזון לבית',
      'שופרסל': 'מזון לבית', 'shufersal': 'מזון לבית', 'שופר סל': 'מזון לבית',
      'רמי לוי': 'מזון לבית', 'rami levy': 'מזון לבית', 'רמי לוי שיווק': 'מזון לבית',
      'יוחננוף': 'מזון לבית', 'yochananof': 'מזון לבית', 'ויקטורי': 'מזון לבית',
      'victory': 'מזון לבית', 'טיב טעם': 'מזון לבית', 'tiv taam': 'מזון לבית',
      'חצי חינם': 'מזון לבית', 'אושר עד': 'מזון לבית', 'osher ad': 'מזון לבית',
      'קרפור': 'מזון לבית', 'carrefour': 'מזון לבית', 'פרשמרקט': 'מזון לבית',
      'יינות ביתן': 'מזון לבית', 'bitan': 'מזון לבית', 'מחסני השוק': 'מזון לבית',
      'סאלח דבאח': 'מזון לבית', 'קשת טעמים': 'מזון לבית', 'am:pm': 'מזון לבית',
      'אי.אם.פי.אם': 'מזון לבית', 'קוויק סופר': 'מזון לבית', 'כוורת': 'מזון לבית',
      'kovert': 'מזון לבית', 'רשת כוורת': 'מזון לבית', 'מאפייה': 'מזון לבית',
      'מאפית לחמים': 'מזון לבית', 'מאפיית לחמים': 'מזון לבית',
      'מעדנייה': 'מזון לבית', 'קליית': 'מזון לבית', 'מגה': 'מזון לבית',
      'זול ובגדול': 'מזון לבית', 'פרש מרקט': 'מזון לבית',
      'זול סטוק': 'מזון לבית',
      'שוק העליה': 'מזון לבית', 'שוק העלייה': 'מזון לבית',
      'ווסט מרקט': 'מזון לבית', 'west market': 'מזון לבית',
      'סופר יודה': 'מזון לבית',
      'סופר האחים': 'מזון לבית',
      "ג'וניור בכיכר": 'מזון לבית', "ג'וניור": 'מזון לבית',
      'העגלה הזולה': 'מזון לבית',

      // ========== פארם ובתי מרקחת (20+) ==========
      'igreen': 'פארם', 'סופרפארם': 'פארם',
      'סופר-פארם': 'פארם', 'super-pharm': 'פארם', 'סופר פארם': 'פארם',
      'be ': 'פארם',
      'be פארם': 'פארם', 'גוד פארם': 'פארם', 'good pharm': 'פארם',
      'ניו פארם': 'פארם', 'מכבי פארם': 'פארם', 'כללית בתי מרקחת': 'פארם',
      'מאוחדת פארם': 'פארם', 'לאומית בתי מרקחת': 'פארם', 'drugstore': 'פארם',
      'דראגסטור': 'פארם', 'epharma': 'פארם', 'איפארמה': 'פארם',
      'medi pharm': 'פארם', 'בית מרקחת': 'פארם', 'pharmacy': 'פארם',
      'בית מרקחת הנגב': 'פארם',
      'קיפוד טאטו': 'פארם', 'קיפוד': 'פארם',

      // ========== אוכל בחוץ ומסעדות (80+) ==========
      'באביס': 'אוכל בחוץ ובילויים', 'בובאס': 'אוכל בחוץ ובילויים', 'bobas': 'אוכל בחוץ ובילויים',
      'ליבי פיטרסי': 'אוכל בחוץ ובילויים',
      'לה גטרי': 'אוכל בחוץ ובילויים', 'la gaterie': 'אוכל בחוץ ובילויים',
      'fasta pasta': 'אוכל בחוץ ובילויים', 'פסטה פסטא': 'אוכל בחוץ ובילויים',
      'קופי סטאר': 'אוכל בחוץ ובילויים', 'coffee star': 'אוכל בחוץ ובילויים',
      'מיבה': 'אוכל בחוץ ובילויים', 'miva': 'אוכל בחוץ ובילויים',
      'bar pardiso': 'אוכל בחוץ ובילויים', 'בר פרדיסו': 'אוכל בחוץ ובילויים',
      'buti': 'אוכל בחוץ ובילויים', 'בוטי': 'אוכל בחוץ ובילויים',
      'מלכה': 'אוכל בחוץ ובילויים', 'ביאטריס': 'אוכל בחוץ ובילויים',
      'קפה בלינה': 'אוכל בחוץ ובילויים', 'קפה נטו': 'אוכל בחוץ ובילויים',
      'jorno bakery': 'אוכל בחוץ ובילויים', "ג'ורנו": 'אוכל בחוץ ובילויים',
      'חוות קורנמל': 'אוכל בחוץ ובילויים',
      'בבקה הבימה': 'אוכל בחוץ ובילויים', 'בבקה': 'אוכל בחוץ ובילויים',
      'מיסטר גרין': 'אוכל בחוץ ובילויים', 'mister green': 'אוכל בחוץ ובילויים',
      'נונומימי': 'אוכל בחוץ ובילויים', 'nonomimi': 'אוכל בחוץ ובילויים',
      'קפאין': 'אוכל בחוץ ובילויים', 'cafein': 'אוכל בחוץ ובילויים',
      'סוויט': 'אוכל בחוץ ובילויים', 'sweet': 'אוכל בחוץ ובילויים',
      'אלמה מרקט': 'אוכל בחוץ ובילויים', 'alma market': 'אוכל בחוץ ובילויים',
      'גולדה': 'אוכל בחוץ ובילויים', 'golda': 'אוכל בחוץ ובילויים',
      'הרב הרב': 'אוכל בחוץ ובילויים', 'hervherv': 'אוכל בחוץ ובילויים',
      'ארומה מנורה': 'אוכל בחוץ ובילויים',
      'ליבי': 'אוכל בחוץ ובילויים', 'ליבי פטיסרי': 'אוכל בחוץ ובילויים', 'פריסטרי': 'אוכל בחוץ ובילויים',
      'אוללה': 'אוכל בחוץ ובילויים', 'מועדון שלך לגמלאי': 'אוכל בחוץ ובילויים',
      'מולי גן יבנה': 'אוכל בחוץ ובילויים', 'מולי': 'אוכל בחוץ ובילויים',
      'מקדונלד': 'אוכל בחוץ ובילויים', 'mcdonald': 'אוכל בחוץ ובילויים',
      'מקדונלדס': 'אוכל בחוץ ובילויים', 'בורגראנץ': 'אוכל בחוץ ובילויים',
      'burgeranch': 'אוכל בחוץ ובילויים', 'בורגר קינג': 'אוכל בחוץ ובילויים',
      'burger king': 'אוכל בחוץ ובילויים', 'דומינו': 'אוכל בחוץ ובילויים',
      'dominos': 'אוכל בחוץ ובילויים', 'פיצה האט': 'אוכל בחוץ ובילויים',
      'pizza hut': 'אוכל בחוץ ובילויים', 'ארומה': 'אוכל בחוץ ובילויים',
      'aroma': 'אוכל בחוץ ובילויים', 'קפה קפה': 'אוכל בחוץ ובילויים',
      'cafe cafe': 'אוכל בחוץ ובילויים', 'ארקפה': 'אוכל בחוץ ובילויים',
      'arcaffe': 'אוכל בחוץ ובילויים', 'קפה גרג': 'אוכל בחוץ ובילויים',
      'ביאטריס': 'אוכל בחוץ ובילויים', 'beatrice': 'אוכל בחוץ ובילויים',
      'ביאטריס פוסט': 'אוכל בחוץ ובילויים', 'ביאטריס קפה': 'אוכל בחוץ ובילויים',
      'frenchy': 'אוכל בחוץ ובילויים', 'yhcnerf': 'אוכל בחוץ ובילויים',
      'שניט': 'אוכל בחוץ ובילויים', 'schnit': 'אוכל בחוץ ובילויים',
      'ביטר': 'אוכל בחוץ ובילויים', 'bitter': 'אוכל בחוץ ובילויים',
      'רולדין': 'אוכל בחוץ ובילויים', 'roladin': 'אוכל בחוץ ובילויים',
      'קופיקס': 'אוכל בחוץ ובילויים', 'cofix': 'אוכל בחוץ ובילויים',
      'ג\'פניקה': 'אוכל בחוץ ובילויים', 'japnika': 'אוכל בחוץ ובילויים',
      'אגאדיר': 'אוכל בחוץ ובילויים', 'agadir': 'אוכל בחוץ ובילויים',
      'bbb': 'אוכל בחוץ ובילויים', 'בורגוס': 'אוכל בחוץ ובילויים',
      'מקס ברנר': 'אוכל בחוץ ובילויים', 'max brenner': 'אוכל בחוץ ובילויים',
      'wolt': 'אוכל בחוץ ובילויים', 'ולט': 'אוכל בחוץ ובילויים',
      'tenbis': 'אוכל בחוץ ובילויים', 'תן ביס': 'אוכל בחוץ ובילויים',
      'מסעדה': 'אוכל בחוץ ובילויים', 'restaurant': 'אוכל בחוץ ובילויים',
      'סושי': 'אוכל בחוץ ובילויים', 'sushi': 'אוכל בחוץ ובילויים',
      'פלאפל': 'אוכל בחוץ ובילויים', 'שווארמה': 'אוכל בחוץ ובילויים',
      'bordo': 'אוכל בחוץ ובילויים', 'בורדו': 'אוכל בחוץ ובילויים',
      'קפה': 'אוכל בחוץ ובילויים', 'cafe': 'אוכל בחוץ ובילויים',
      'בר': 'אוכל בחוץ ובילויים', 'פאב': 'אוכל בחוץ ובילויים',

      // ========== חדר כושר ==========
      'ספייס': 'חדר כושר', 'space gym': 'חדר כושר', 'ספייס גים': 'חדר כושר',
      'הולמס פלייס': 'חדר כושר', 'holmes place': 'חדר כושר', 'הולמס פלייס מתחם': 'חדר כושר',

      // ========== בילויים ותרבות (40+) ==========
      'yes planet': 'תחביבים', 'יס פלאנט': 'תחביבים', 'סינמה סיטי': 'תחביבים',
      'cinema city': 'תחביבים', 'קולנוע לב': 'תחביבים', 'hot cinema': 'תחביבים',
      'הבימה': 'תחביבים', 'הקאמרי': 'תחביבים', 'בית ליסין': 'תחביבים',
      'היכל התרבות': 'תחביבים', 'זאפה': 'תחביבים', 'zappa': 'תחביבים',
      'מייקס פלייס': 'תחביבים', 'mike\'s place': 'תחביבים',
      'סופרלנד': 'תחביבים', 'לונא פארק': 'תחביבים', 'ימית 2000': 'תחביבים',
      'גרייט שייפ': 'תחביבים', 'great shape': 'תחביבים',
      'קרוספיט': 'תחביבים', 'crossfit': 'תחביבים', 'קרוס פיט': 'תחביבים',
      'openai': 'תחביבים', 'chatgpt': 'תחביבים', 'chat gpt': 'תחביבים',
      'סטודיו c': 'תחביבים', 'כושר': 'תחביבים', 'gym': 'תחביבים',
      'fitness': 'תחביבים', 'סינמה': 'תחביבים', 'cinema': 'תחביבים',
      'קולנוע': 'תחביבים', 'תיאטרון': 'תחביבים', 'מוזיאון': 'תחביבים',
      'לוינגר': 'תחביבים', 'אסקייפ רום': 'תחביבים',
      'קאנטרי': 'תחביבים', 'קאנטרי חשמונאים': 'תחביבים', 'country': 'תחביבים',

      // ========== טיפוח וקוסמטיקה (25+) ==========
      'אפריל': 'תספורת וקוסמטיקה', 'april': 'תספורת וקוסמטיקה',
      'איל מקיאג': 'תספורת וקוסמטיקה', 'il makiage': 'תספורת וקוסמטיקה',
      'ללין': 'תספורת וקוסמטיקה', 'laline': 'תספורת וקוסמטיקה',
      'sabon': 'תספורת וקוסמטיקה', 'סבון': 'תספורת וקוסמטיקה',
      'סקארה': 'תספורת וקוסמטיקה', 'sacara': 'תספורת וקוסמטיקה',
      'mac': 'תספורת וקוסמטיקה', 'body shop': 'תספורת וקוסמטיקה',
      'wow cosmetics': 'תספורת וקוסמטיקה', 'קרולינה למקה': 'תספורת וקוסמטיקה',
      'ביוטיקייר': 'תספורת וקוסמטיקה', 'beautycare': 'תספורת וקוסמטיקה',
      'heads': 'תספורת וקוסמטיקה', 'שוקי זיקרי': 'תספורת וקוסמטיקה',
      'יואל יוסף': 'תספורת וקוסמטיקה', 'תספורת': 'תספורת וקוסמטיקה',
      'מספרה': 'תספורת וקוסמטיקה', 'barber': 'תספורת וקוסמטיקה',
      'ספר': 'תספורת וקוסמטיקה', 'קוסמטיקה': 'תספורת וקוסמטיקה',

      // ========== דלק וחניה (25+) ==========
      'ספרינט סונול': 'דלק וחניה', 'sprint sonol': 'דלק וחניה',
      'פז': 'דלק וחניה', 'paz': 'דלק וחניה', 'yellow': 'דלק וחניה',
      'דלק': 'דלק וחניה', 'delek': 'דלק וחניה', 'מנטה': 'דלק וחניה', 'menta': 'דלק וחניה',
      'סונול': 'דלק וחניה', 'sonol': 'דלק וחניה', 'so good': 'דלק וחניה',
      'דור אלון': 'דלק וחניה', 'dor alon': 'דלק וחניה', 'אלונית': 'דלק וחניה',
      'ten': 'דלק וחניה', 'טן': 'דלק וחניה', 'אחוזות החוף': 'דלק וחניה',
      'חניוני הצלחה': 'דלק וחניה', 'pango': 'דלק וחניה', 'פנגו': 'דלק וחניה',
      'cellopark': 'דלק וחניה', 'סלופארק': 'דלק וחניה', 'סילו פארק': 'דלק וחניה',
      'איזי פארק': 'דלק וחניה', 'easy park': 'דלק וחניה',
      'נאייקס': 'דלק וחניה', 'nayax': 'דלק וחניה', 'נאייקס ישראל': 'דלק וחניה',
      'בול אשדוד': 'דלק וחניה', 'בול תחנה': 'דלק וחניה', 'בול אשדוד תחנה': 'דלק וחניה', 'תחנה 371': 'דלק וחניה',
      'חניה': 'דלק וחניה', 'חניון': 'דלק וחניה', 'parking': 'דלק וחניה',
      'סנטראל פארק אשדוד': 'דלק וחניה', 'סנטראל פארק': 'דלק וחניה',
      'סנטרל פארק': 'דלק וחניה', 'אוטוטו': 'דלק וחניה',

      // ========== תחבורה ציבורית (30+) ==========
      'אגד': 'תחבצ', 'egged': 'תחבצ', 'דן': 'תחבצ', 'dan': 'תחבצ',
      'מטרופולין': 'תחבצ', 'metropolin': 'תחבצ', 'קווים': 'תחבצ', 'kavim': 'תחבצ',
      'אפיקים': 'תחבצ', 'afikim': 'תחבצ', 'נתיב אקספרס': 'תחבצ',
      'סופרבוס': 'תחבצ', 'superbus': 'תחבצ', 'רכבת ישראל': 'תחבצ',
      'רכבת': 'תחבצ', 'train': 'תחבצ', 'רכבת קלה': 'תחבצ', 'כרמלית': 'תחבצ',
      'gett': 'תחבצ', 'גט': 'תחבצ', 'גט טקסי': 'תחבצ', 'מונית': 'תחבצ', 'taxi': 'תחבצ',
      'uber': 'תחבצ', 'אובר': 'תחבצ', 'yango': 'תחבצ', 'יאנגו': 'תחבצ',
      'מוביט': 'תחבצ', 'moovit': 'תחבצ', 'רב קו': 'תחבצ', 'rav kav': 'תחבצ',
      'אוטובוס': 'תחבצ', 'מ.תחבורה': 'תחבצ', 'תחבורה ציבורית': 'תחבצ',
      'dott': 'תחבצ', 'dott scooter': 'תחבצ', 'dott scooter ride': 'תחבצ',
      'lime': 'תחבצ', 'lime pvgk': 'תחבצ', 'bird': 'תחבצ', 'wind': 'תחבצ',
      'רב קו אונליין': 'תחבצ',

      // ========== בנקים ומשכנתא (25+) ==========
      'מזרחי-טפחות': 'משכנתא', 'מזרחי טפחות': 'משכנתא', 'בנק הפועלים': 'משכנתא',
      'הפועלים': 'משכנתא', 'בנק לאומי': 'משכנתא', 'לאומי': 'עמלות בנק ואשראי',
      'בנק דיסקונט': 'משכנתא', 'דיסקונט': 'עמלות בנק ואשראי',
      'הבינלאומי': 'משכנתא', 'בנק ירושלים': 'משכנתא', 'מרכנתיל': 'משכנתא',
      'בנק יהב': 'משכנתא', 'יהב': 'עמלות בנק ואשראי', 'בנק מסד': 'משכנתא',
      'בנק אגוד': 'משכנתא', 'בנק הדואר': 'עמלות בנק ואשראי',
      'pepper': 'עמלות בנק ואשראי', 'פפר': 'עמלות בנק ואשראי',
      'one zero': 'עמלות בנק ואשראי', 'וואן זירו': 'עמלות בנק ואשראי',
      'משכנתא': 'משכנתא', 'משכנתה': 'משכנתא', 'mortgage': 'משכנתא',

      // ========== שכר דירה (20+) ==========
      'עמידר': 'שכר דירה', 'עמיגור': 'שכר דירה', 'חלמיש': 'שכר דירה',
      'שקמונה': 'שכר דירה', 'דירה להשכיר': 'שכר דירה', 'אזורים living': 'שכר דירה',
      'מגוריט': 'שכר דירה', 'meguritt': 'שכר דירה', 'אשטרום מגורים': 'שכר דירה',
      'פרזות': 'שכר דירה', 'שכר דירה': 'שכר דירה', 'rent': 'שכר דירה',
      'שכירות': 'שכר דירה', 'דירה': 'שכר דירה',

      // ========== ועד בית וניהול בניין (20+) ==========
      'מיי טאוור': 'דמי ניהול בניין', 'my tower': 'דמי ניהול בניין',
      'אדן ניהול': 'דמי ניהול בניין', 'קלינטון': 'דמי ניהול בניין',
      'easyhouse': 'דמי ניהול בניין', 'איזי האוס': 'דמי ניהול בניין',
      'קופמן פליישר': 'דמי ניהול בניין', 'לביא ניהול': 'דמי ניהול בניין',
      'י.ש אחזקת': 'דמי ניהול בניין', 'ועד בית': 'דמי ניהול בניין',
      'ניהול בניין': 'דמי ניהול בניין', 'אחזקת מבנים': 'דמי ניהול בניין',

      // ========== ציוד עסקי/משרדי (NEW) ==========
      'משכן שיווק': 'ציוד עסקי/משרדי', 'דף למשרד': 'ציוד עסקי/משרדי', 'דף ': 'ציוד עסקי/משרדי',

      // ========== ארנונה - עיריות (20+) ==========
      'עיריית אשדוד חניה': 'דלק וחניה', 'עיריית אשדוד חנייה': 'דלק וחניה',
      'עריית אשדוד חניה': 'דלק וחניה', 'עריית אשדוד חנייה': 'דלק וחניה',
      'עיריית תל אביב חניה': 'דלק וחניה', 'עיריית תל אביב חנייה': 'דלק וחניה',
      'עיריית תל אביב': 'ארנונה', 'עיריית ירושלים': 'ארנונה', 'עיריית חיפה': 'ארנונה',
      'עיריית ראשון': 'הוצאות בית', 'עיריית פתח תקווה': 'הוצאות בית', 'עיריית אשדוד': 'הוצאות בית',
      'עיריית נתניה': 'הוצאות בית', 'עיריית באר שבע': 'הוצאות בית', 'עיריית בני ברק': 'הוצאות בית',
      'עיריית חולון': 'הוצאות בית', 'עיריית רמת גן': 'הוצאות בית', 'עיריית אשקלון': 'הוצאות בית',
      'עיריית רחובות': 'הוצאות בית', 'עיריית בת ים': 'הוצאות בית', 'עיריית בית שמש': 'הוצאות בית',
      'ארנונה': 'הוצאות בית', 'עירייה': 'הוצאות בית', 'עיריי': 'הוצאות בית', 'municipality': 'הוצאות בית',

      // ========== הוצאות בית - חשמל, מים, גז, ארנונה ==========
      // חשמל
      'חברת החשמל': 'הוצאות בית', 'חשמל לישראל': 'הוצאות בית', 'סופר-פאוור': 'הוצאות בית',
      'super power': 'הוצאות בית', 'אמישראגז אנרג\'י': 'הוצאות בית', 'בזק אנרגיה': 'הוצאות בית',
      'סלקום אנרג\'י': 'הוצאות בית', 'הוט אנרג\'י': 'הוצאות בית', 'פרטנר פאוור': 'הוצאות בית',
      'דוראד': 'הוצאות בית', 'dorad': 'הוצאות בית', 'חשמל': 'הוצאות בית', 'electric': 'הוצאות בית',
      // מים וביוב
      'מי אביבים': 'הוצאות בית', 'הגיחון': 'הוצאות בית', 'מי כרמל': 'הוצאות בית',
      'מניב ראשון': 'הוצאות בית', 'מי נתניה': 'הוצאות בית', 'מי הרצליה': 'הוצאות בית',
      'מי שבע': 'הוצאות בית', 'מי באר שבע': 'הוצאות בית', 'יובלים אשדוד': 'הוצאות בית',
      'מי אשקלון': 'הוצאות בית', 'פלג הגליל': 'הוצאות בית', 'פלגי שרון': 'הוצאות בית',
      'מי מודיעין': 'הוצאות בית', 'מי רעננה': 'הוצאות בית', 'מי בת ים': 'הוצאות בית',
      'מי שמש': 'הוצאות בית', 'מי גת': 'הוצאות בית', 'מים': 'הוצאות בית', 'ביוב': 'הוצאות בית',
      // גז
      'פזגז': 'הוצאות בית', 'פז גז': 'הוצאות בית', 'pazgas': 'הוצאות בית', 'סופרגז': 'הוצאות בית', 'supergas': 'הוצאות בית',
      'אמישראגז': 'הוצאות בית', 'amigaz': 'הוצאות בית', 'דורגז': 'הוצאות בית', 'גז יגל': 'הוצאות בית',
      'מרכז הגז': 'הוצאות בית', 'גזגל': 'הוצאות בית', 'אינטרגז': 'הוצאות בית', 'intergas': 'הוצאות בית',
      'מיקה גז': 'הוצאות בית', 'גזית גז': 'הוצאות בית', 'גז': 'הוצאות בית',

      // ========== מתנות לאירועים (20+) ==========
      'buyme': 'מתנות', 'ביימי': 'מתנות', 'easy2give': 'מתנות', 'איזי טו גיב': 'מתנות',
      'easycard': 'מתנות', 'איזי קארד': 'מתנות', 'מתנה': 'מתנות', 'matana': 'מתנות',
      'wiwi': 'מתנות', 'וויווי': 'מתנות', 'pai-pay': 'מתנות', 'פאי-גיפט': 'מתנות',
      'wedix': 'מתנות', 'זר4יו': 'מתנות', 'zer4u': 'מתנות', 'gentleman': 'מתנות',
      'גנטלמן': 'מתנות', 'soho': 'מתנות', 'gadget shop': 'מתנות', 'gift': 'מתנות',

      // ========== ביגוד והנעלה (30+) ==========
      'אינטימה און ליין': 'ביגוד והנעלה', 'אינטימה': 'ביגוד והנעלה', 'intima': 'ביגוד והנעלה',
      'או מיי בוקס': 'ביגוד והנעלה', 'oh my box': 'ביגוד והנעלה',
      'בלוברי': 'ביגוד והנעלה', 'bluberi': 'ביגוד והנעלה', 'בלוברי טי אל וי': 'ביגוד והנעלה',
      'איניטה': 'ביגוד והנעלה',
      'קסטרו': 'ביגוד והנעלה', 'castro': 'ביגוד והנעלה', 'פוקס': 'ביגוד והנעלה',
      'fox': 'ביגוד והנעלה', 'זארה': 'ביגוד והנעלה', 'zara': 'ביגוד והנעלה',
      'h&m': 'ביגוד והנעלה', 'מנגו': 'ביגוד והנעלה', 'mango': 'ביגוד והנעלה',
      'רנואר': 'ביגוד והנעלה', 'renuar': 'ביגוד והנעלה', 'אורבניקה': 'ביגוד והנעלה',
      'urbanica': 'ביגוד והנעלה', 'גולף': 'ביגוד והנעלה', 'golf': 'ביגוד והנעלה',
      'hoodies': 'ביגוד והנעלה', 'הודיס': 'ביגוד והנעלה', 'אדידס': 'ביגוד והנעלה',
      'adidas': 'ביגוד והנעלה', 'נייקי': 'ביגוד והנעלה', 'nike': 'ביגוד והנעלה',
      'foot locker': 'ביגוד והנעלה', 'דלתא': 'ביגוד והנעלה',
      'terminal x': 'ביגוד והנעלה', 'טרמינל x': 'ביגוד והנעלה',
      'טרמינל איקס': 'ביגוד והנעלה', 'איקס אונליין': 'ביגוד והנעלה',
      'asos': 'ביגוד והנעלה', 'בנות ישראל': 'ביגוד והנעלה', 'twentysix': 'ביגוד והנעלה',
      'ובידך כוח': 'ביגוד והנעלה', 'כוח וגבורה': 'ביגוד והנעלה',
      'נעליים': 'ביגוד והנעלה', 'shoes': 'ביגוד והנעלה', 'ביגוד': 'ביגוד והנעלה',
      'אניטה': 'ביגוד והנעלה', 'aliexpress': 'ביגוד והנעלה',

      // ========== סיגריות וטבק (NEW - 15+) ==========
      'yellow רכישה': 'סיגריות', 'menta רכישה': 'סיגריות',
      'sogood': 'סיגריות', '7-eleven': 'סיגריות', 'סבן אילבן': 'סיגריות',
      'קיוסק': 'סיגריות', 'פיצוציה': 'סיגריות', 'duty free': 'סיגריות',
      'טבק': 'סיגריות', 'סיגריות': 'סיגריות', 'מקדש הטבק': 'סיגריות',

      // ========== חופשה וטיול (30+) ==========
      'תיירות ונופש': 'חופשה וטיול', 'תיירות': 'חופשה וטיול',
      'איסתא': 'חופשה וטיול', 'issta': 'חופשה וטיול', 'הדקה ה-90': 'חופשה וטיול',
      'גוליבר': 'חופשה וטיול', 'gulliver': 'חופשה וטיול', 'ארקיע': 'חופשה וטיול',
      'arkia': 'חופשה וטיול', 'אל על': 'חופשה וטיול', 'elal': 'חופשה וטיול',
      'ישראייר': 'חופשה וטיול', 'israir': 'חופשה וטיול', 'booking': 'חופשה וטיול',
      'booking.com': 'חופשה וטיול', 'airbnb': 'חופשה וטיול', 'איירביאנבי': 'חופשה וטיול',
      'פתאל': 'חופשה וטיול', 'fattal': 'חופשה וטיול', 'לאונרדו': 'חופשה וטיול',
      'הרודס': 'חופשה וטיול', 'ישרוטל': 'חופשה וטיול', 'isrotel': 'חופשה וטיול',
      'דן מלונות': 'חופשה וטיול', 'אשת טורס': 'חופשה וטיול', 'אופיר טורס': 'חופשה וטיול',
      'expedia': 'חופשה וטיול', 'אקספדיה': 'חופשה וטיול', 'טיסה': 'חופשה וטיול',
      'flight': 'חופשה וטיול', 'מלון': 'חופשה וטיול', 'hotel': 'חופשה וטיול',
      'agoda': 'חופשה וטיול', 'הוסטל': 'חופשה וטיול',

      // ========== עוזרת בית ושמרטף (NEW - 15+) ==========
      'עוזרות': 'עוזרת בית', 'cleaning lady': 'עוזרת בית', 'אייל ניקיון': 'עוזרת בית',
      'א.א.א ניקיון': 'עוזרת בית', 'עוזרתלי': 'עוזרת בית', 'ozeretli': 'עוזרת בית',
      'helpbook': 'עוזרת בית', 'הלפבוק': 'עוזרת בית', 'babysitter': 'עוזרת בית',
      'בייביסיטר': 'עוזרת בית', 'babysits': 'עוזרת בית', 'בייביסיטס': 'עוזרת בית',
      'שמרטף': 'עוזרת בית', 'מטפלת': 'עוזרת בית', 'עוזרת בית': 'עוזרת בית',

      // ========== תיקוני רכב ומוסכים (25+) ==========
      'אוטו דיפו': 'תיקוני רכב', 'auto depot': 'תיקוני רכב', 'צ\'ק-אפ': 'תיקוני רכב',
      'check-up': 'תיקוני רכב', 'שגריר': 'תיקוני רכב', 'shagrir': 'תיקוני רכב',
      'bosch car service': 'תיקוני רכב', 'בוש קאר': 'תיקוני רכב',
      'ד"ר פח וצבע': 'תיקוני רכב', 'כלמוביל': 'תיקוני רכב', 'צ\'מפיון': 'תיקוני רכב',
      'קומפיוטסט': 'תיקוני רכב', 'computest': 'תיקוני רכב',
      'טכנו-טסט': 'תיקוני רכב', 'technotest': 'תיקוני רכב',
      'חגי אופנועים': 'תיקוני רכב', 'אופנועים': 'תיקוני רכב',
      'מוסך': 'תיקוני רכב', 'garage': 'תיקוני רכב', 'צמיגים': 'תיקוני רכב',
      'tires': 'תיקוני רכב', 'bestdrive': 'תיקוני רכב', 'גלגלים': 'תיקוני רכב',

      // ========== בעלי חיים (25+) ==========
      'אניפט': 'בעלי חיים', 'anipet': 'בעלי חיים', 'petway': 'בעלי חיים',
      'דרך החיות': 'בעלי חיים', 'זו ארץ זו': 'בעלי חיים', 'ספידוג': 'בעלי חיים',
      'speedog': 'בעלי חיים', 'הג\'ונגל': 'בעלי חיים', 'jungle': 'בעלי חיים',
      'הג\'ונגל של אלי': 'בעלי חיים', 'petbest': 'בעלי חיים', 'פטבסט': 'בעלי חיים',
      'פט בסט': 'בעלי חיים', 'pet best': 'בעלי חיים',
      'גג לחיות': 'בעלי חיים', 'קן התוכי': 'בעלי חיים', 'תן לחיות': 'בעלי חיים',
      'zooplus': 'בעלי חיים', 'וטרינר': 'בעלי חיים', 'vet': 'בעלי חיים',
      'מזון לכלבים': 'בעלי חיים', 'מזון לחתולים': 'בעלי חיים', 'חיות מחמד': 'בעלי חיים',

      // ========== צעצועים וילדים (NEW - 25+) ==========
      'toys r us': 'צעצועים', 'טויס אר אס': 'צעצועים', 'כפר השעשועים': 'צעצועים',
      'הפיראט האדום': 'צעצועים', 'עידן 2000': 'צעצועים', 'צעצועי מורן': 'צעצועים',
      'שילב': 'צעצועים', 'shilav': 'צעצועים', 'מוצצים': 'צעצועים',
      'baby star': 'צעצועים', 'בייבי סטאר': 'צעצועים', 'fox kids': 'צעצועים',
      'פוקס קידס': 'צעצועים', 'lego store': 'צעצועים', 'לגו': 'צעצועים',
      'gymboree': 'צעצועים', 'ג\'ימבורי': 'צעצועים', 'צעצועים': 'צעצועים',
      'צעצוע': 'צעצועים', 'toys': 'צעצועים',

      // ========== חינוך וקייטנות (30+) ==========
      'משרד החינוך': 'חינוך וקייטנות', 'מתנ"ס': 'חינוך וקייטנות', 'מתנס': 'חינוך וקייטנות',
      'הצופים': 'חינוך וקייטנות', 'בני עקיבא': 'חינוך וקייטנות',
      'הנוער העובד': 'חינוך וקייטנות', 'השומר הצעיר': 'חינוך וקייטנות',
      'helen doron': 'חינוך וקייטנות', 'הלן דורון': 'חינוך וקייטנות',
      'my gym': 'חינוך וקייטנות', 'מיי ג\'ים': 'חינוך וקייטנות',
      'ימאהה': 'חינוך וקייטנות', 'yamaha music': 'חינוך וקייטנות',
      'high-q': 'חינוך וקייטנות', 'קידום': 'חינוך וקייטנות',
      'חינוך': 'חינוך וקייטנות', 'קייטנה': 'חינוך וקייטנות', 'קייטנת': 'חינוך וקייטנות',
      'גן ילדים': 'חינוך וקייטנות', 'בית ספר': 'חינוך וקייטנות',
      'אוניברסיטה': 'חינוך וקייטנות', 'שכר לימוד': 'חינוך וקייטנות', 'חוג': 'חינוך וקייטנות',
      'שכ"ל': 'חינוך וקייטנות', 'שכל אינטרנט': 'חינוך וקייטנות', 'שכ"ל אינטרנט': 'חינוך וקייטנות',

      // ========== תרומות (20+) ==========
      'יד שרה': 'תרומות', 'לתת': 'תרומות', 'עזר מציון': 'תרומות',
      'ויצו': 'תרומות', 'wizo': 'תרומות', 'האגודה למלחמה בסרטן': 'תרומות',
      'איל"ן': 'תרומות', 'ilan': 'תרומות', 'זכרון מנחם': 'תרומות',
      'פתחון לב': 'תרומות', 'לקט ישראל': 'תרומות', 'תנו לחיות לחיות': 'תרומות',
      'זק"א': 'תרומות', 'zaka': 'תרומות', 'איחוד הצלה': 'תרומות',
      'מגן דוד אדום': 'תרומות', 'מד"א': 'תרומות', 'ידידים': 'תרומות',
      'עמותת חיים': 'תרומות', 'תרומה': 'תרומות', 'נדבה': 'תרומות',

      // ========== כבישי אגרה ==========
      'כביש 6': 'כבישי אגרה', 'כביש שש': 'כבישי אגרה', 'מנהרות הכרמל': 'כבישי אגרה',
      'כרמל טונל': 'כבישי אגרה', 'נתיבי איילון': 'כבישי אגרה', 'fast lane': 'כבישי אגרה',

      // ========== מיסים ==========
      'מס הכנסה': 'מיסים', 'נציבות מס': 'מיסים', 'מעמ': 'מיסים', 'מע"מ': 'מיסים',
      'גביית מעמ': 'מיסים', 'רשות המסים': 'מיסים', 'מס רכוש': 'מיסים',

      // ========== עמלות בנק ואשראי (20+) ==========
      'דמי כרטיס': 'עמלות בנק ואשראי', 'דמי ניהול': 'עמלות בנק ואשראי',
      'עמלה': 'עמלות בנק ואשראי', 'עמלת sms': 'עמלות בנק ואשראי',
      'עמלת פעולות': 'עמלות בנק ואשראי', 'ריבית על מינוס': 'עמלות בנק ואשראי',
      'ריבית חובה': 'עמלות בנק ואשראי', 'עמלת משיכה': 'עמלות בנק ואשראי',
      'ויזה כאל': 'עמלות בנק ואשראי', 'visa cal': 'עמלות בנק ואשראי',
      'ישראכרט': 'עמלות בנק ואשראי', 'isracard': 'עמלות בנק ואשראי',
      'max': 'עמלות בנק ואשראי', 'מקס': 'עמלות בנק ואשראי',
      'amex': 'עמלות בנק ואשראי', 'אמריקן אקספרס': 'עמלות בנק ואשראי',
      'דיינרס': 'עמלות בנק ואשראי', 'diners': 'עמלות בנק ואשראי',

      // ========== החזר הלוואות (20+) ==========
      'מימון ישיר': 'החזר הלוואות', 'בלנדר': 'החזר הלוואות', 'blender': 'החזר הלוואות',
      'tarya': 'החזר הלוואות', 'טריא': 'החזר הלוואות', 'eloan': 'החזר הלוואות',
      'כלל מימון': 'החזר הלוואות', 'הראל מימון': 'החזר הלוואות',
      'כאל מימון': 'החזר הלוואות', 'max הלוואות': 'החזר הלוואות',
      'ישראכרט הלוואות': 'החזר הלוואות', 'החזר הלוואה': 'החזר הלוואות',
      'הלוואה': 'החזר הלוואות', 'loan': 'החזר הלוואות', 'גמ"ח': 'החזר הלוואות',

      // ========== ביטוח לאומי ==========
      'ביטוח לאומי': 'ביטוח לאומי', 'בטל': 'ביטוח לאומי', 'bituach leumi': 'ביטוח לאומי',

      // ========== ריהוט והבית ==========
      'איקאה': 'ריהוט והבית', 'ikea': 'ריהוט והבית', 'ריהוט': 'ריהוט והבית',
      'רהיטים': 'ריהוט והבית', 'מיניסו': 'ריהוט והבית', 'miniso': 'ריהוט והבית',
      'fox home': 'ריהוט והבית', 'פוקס הום': 'ריהוט והבית', 'h&o home': 'ריהוט והבית',
      'המשביר': 'כלי בית',

      // ========== שונות ==========
      'כרטיס נטען': 'שונות', 'נטען בהצדעה': 'שונות', 'בהצדעה': 'שונות',
      'ריוט': 'שונות', 'riot': 'שונות',
      'רחלי שטרן': 'שונות', 'מרכז לתזונה': 'שונות',
      'פייפרלס': 'שונות', 'paperless': 'שונות',

      // ========== חסכונות ==========
      'חסכון מפתח': 'חסכונות'
    };

    // פונקציה לקטלוג מהמאגר
    function categorizeByDatabase(description) {
      if (!description) return null;
      const lowerDesc = description.toLowerCase().trim();
      
      // #region agent log
      console.log(`🔍 categorizeByDatabase checking: "${description}"`);
      // #endregion
      
      // מיון לפי אורך - מילים ארוכות קודם! (כדי ש"בלוברי" יתאים לפני "בר")
      const sortedEntries = Object.entries(BUSINESS_DATABASE).sort((a, b) => b[0].length - a[0].length);
      
      for (const [keyword, category] of sortedEntries) {
        if (lowerDesc.includes(keyword.toLowerCase())) {
          console.log(`✅ מאגר: "${description}" → ${category} (מילה: "${keyword}")`);
          return category;
        }
      }
      
      console.log(`❌ NO MATCH in DB: "${description}"`);
      return null;
    }

    // === פרסר תשלומים חכם - מזהה תבניות בדוח מיפוי ובכרטיסי אשראי ===
    function parseInstallment(description, amount) {
      const patterns = [
        /תשלום\s+(\d+)[\/\-](\d+)/i,           // "תשלום 11/12"
        /תשלום\s*(\d+)\s*מתוך\s*(\d+)/i,       // "תשלום 11 מתוך 12" (דוח מיפוי)
        /חלק\s*(\d+)\s*מתוך\s*(\d+)/i,        // "חלק 1 מתוך 12"
        /(\d+)\s*מ[־\-]\s*(\d+)/,              // "11 מ-12"
        /(\d+)\s*\/\s*(\d+)\s*תשלומים/,        // "11/12 תשלומים"
        /(\d+)\s*מתוך\s*(\d+)\s*תשלומים/,      // "1 מתוך 12 תשלומים"
        /(\d+)\s*מתוך\s*(\d+)/,                // "11 מתוך 12"
        /בתשלומים\s*[\(\s]*(\d+)\s*[\/\-]\s*(\d+)/i,  // "בתשלומים (1/12)" או "בתשלומים 1/12"
        /פריסה\s*(\d+)\s*[\/\-]\s*(\d+)/i,     // "פריסה 1/12"
        /(?:תשלום\s*)?(\d+)\s*\/\s*(\d+)\s*$/, // "שם בית עסק 1/12" בסוף השורה
        /payment\s+(\d+)[\/\-](\d+)/i,         // "payment 11/12"
        /(\d+)\s*of\s*(\d+)/i,                 // "11 of 12"
        /תש[׳']?\s*(\d+)[\/\-](\d+)/,          // "תש' 11/12"
        /שלום\s+(\d+)[\/\-](\d+)/              // "שלום 11/12" (טעות הקלדה נפוצה)
      ];
      
      for (const pattern of patterns) {
        const match = description.match(pattern);
        if (match) {
          const current = parseInt(match[1]);
          const total = parseInt(match[2]);
          // הגבלה לסדרת תשלומים סבירה (מונע זיהוי תאריכים כמו 2024/2025)
          if (current > 0 && total > 0 && total <= 60 && current <= total && total > 1) {
            // חשב את התשלום החודשי
            const monthlyAmount = Math.round(amount / (total - current + 1));
            
            return {
              isInstallment: true,
              installment_current: current,
              installment_total: total,
              monthly_amount: monthlyAmount,
              total_amount: amount,
              remaining: total - current + 1
            };
          }
        }
      }
      
      return { isInstallment: false };
    }

    // === תיקון אוטומטי + וולידציה ===
    function autoCorrectAndValidate(expense) {
      if (!expense || !expense.description) return expense;
      
      const desc = expense.description.toLowerCase();
      
      // === זיהוי החזרים כספיים (סכומים שליליים או מילות מפתח) ===
      if (expense.amount < 0) {
        expense.isRefund = true;
        expense.refund_note = 'החזר כספי';
        console.log(`💰 החזר כספי זוהה (סכום שלילי): "${expense.description}" - ${expense.amount}₪`);
      }
      
      // זיהוי החזרים לפי מילות מפתח בתיאור
      const refundKeywords = ['ביטול עסקה', 'ביטול', 'החזר', 'זיכוי', 'refund', 'cancel'];
      if (refundKeywords.some(keyword => desc.includes(keyword.toLowerCase()))) {
        expense.isRefund = true;
        expense.refund_note = 'החזר כספי';
        // הפוך את הסכום לשלילי אם הוא חיובי
        if (expense.amount > 0) {
          expense.amount = -Math.abs(expense.amount);
        }
        console.log(`💰 החזר כספי זוהה (מילת מפתח): "${expense.description}" - ${expense.amount}₪`);
      }
      
      // === תיקון קטגוריות לא תקינות שה-AI יוצר ===
      const invalidCategoryMapping = {
        'אופנה': 'ביגוד והנעלה',
        'fashion': 'ביגוד והנעלה',
        'מסעדות': 'אוכל בחוץ ובילויים',
        'מזון ומשקאות': 'מזון לבית',
        'מוסדות': 'שונות',
        'מזון מהיר': 'אוכל בחוץ ובילויים',
        'פנאי בילוי': 'תחביבים',
        'תיירות': 'חופשה וטיול',
        'רכב ותחבורה': 'תחבצ',
        'חינוך': 'חינוך וקייטנות',
        'קניות': 'שונות',
        'בידור': 'תחביבים',
        'אנרגיה': 'הוצאות בית',
        'ארנונה': 'הוצאות בית',
        'חשמל': 'הוצאות בית',
        'גז': 'הוצאות בית',
        'מים וביוב': 'הוצאות בית'
      };
      
      if (invalidCategoryMapping[expense.category]) {
        const newCategory = invalidCategoryMapping[expense.category];
        console.log(`🔄 Auto-correct category: "${expense.description}" ${expense.category} → ${newCategory}`);
        expense.category = newCategory;
        expense.auto_corrected = true;
      }
      
      // === תיקון קריטי 0: ביטוח לאומי (חייב להיות ראשון!) ===
      if (desc.includes('ביטוח לאומי')) {
        if (expense.category !== 'ביטוח לאומי') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"ביטוח לאומי"`);
          expense.category = 'ביטוח לאומי';
          expense.auto_corrected = true;
        }
        return expense; // יציאה מוקדמת - זה ביטוח לאומי ותו לא
      }
      
      // === תיקון קריטי 1: מיסים ===
      if (desc.includes('נציבות מס') || desc.includes('מס הכנסה') || desc.includes('גביית מעמ')) {
        if (expense.category !== 'מיסים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"מיסים"`);
          expense.category = 'מיסים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 2: עמלות כרטיס ===
      if (desc.includes('דמי כרטיס') || desc.includes('עמלת כרטיס')) {
        // בדיקה אם יש הנחה - אם כתוב "הנחה" בתיאור, מאפסים את הסכום
        if (desc.includes('הנחה')) {
          console.log(`🔧 דמי כרטיס עם הנחה - מאפס: "${expense.description}"`);
          expense.amount = 0;
          expense.has_discount = true;
          expense.category = 'עמלות בנק ואשראי';
          expense.auto_corrected = true;
          return expense;
        }
        if (expense.category !== 'עמלות בנק ואשראי') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"עמלות בנק ואשראי"`);
          expense.category = 'עמלות בנק ואשראי';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === זיהוי הנחות שמאפסות עמלות ===
      if (desc.includes('הנחה') && (desc.includes('דמי') || desc.includes('עמלה'))) {
        console.log(`🔧 הנחה על עמלה - לא נספור: "${expense.description}"`);
        expense.amount = 0;
        expense.has_discount = true;
        expense.category = 'עמלות בנק ואשראי';
        expense.auto_corrected = true;
        return expense;
      }
      
      // === תיקון קריטי 3: תחבורה ציבורית ===
      if (desc.includes('מ.תחבורה') || desc.includes('פנגו מוביט') || desc.includes('moovit') || 
          desc.includes('דן חברה לתחבורה') || desc.includes('דן תחבורה')) {
        if (expense.category !== 'תחבצ') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"תחבצ"`);
          expense.category = 'תחבצ';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 4: חניונים ומכונות תשלום ===
      if (desc.includes('אחוזות החוף') || desc.includes('נאייקס') || desc.includes('סילו פארק') || desc.includes('סלופארק')) {
        if (expense.category !== 'דלק וחניה') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"דלק וחניה"`);
          expense.category = 'דלק וחניה';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 5: קרוספיט = תחביבים ===
      if (desc.includes('קרוספיט') || desc.includes('crossfit')) {
        if (expense.category !== 'תחביבים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"תחביבים"`);
          expense.category = 'תחביבים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 6: מאפיות = מזון לבית ===
      if (desc.includes('מאפית לחמים') || desc.includes('מאפיית לחמים')) {
        if (expense.category !== 'מזון לבית') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"מזון לבית"`);
          expense.category = 'מזון לבית';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 7: אגרת משרד התחבורה = כבישי אגרה ===
      if (desc.includes('משרד התחבורה') && desc.includes('אגרה')) {
        if (expense.category !== 'כבישי אגרה') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"כבישי אגרה"`);
          expense.category = 'כבישי אגרה';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 8: ברים וקפה = אוכל בחוץ ===
      if (desc.includes('שניט') || desc.includes('ביטר') || desc.includes('ביאטריס')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 9: ChatGPT = תחביבים ===
      if (desc.includes('openai') || desc.includes('chatgpt')) {
        if (expense.category !== 'תחביבים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"תחביבים"`);
          expense.category = 'תחביבים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 10: אופנועים = תיקוני רכב ===
      if (desc.includes('חגי אופנועים') || desc.includes('אופנועים')) {
        if (expense.category !== 'תיקוני רכב') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"תיקוני רכב"`);
          expense.category = 'תיקוני רכב';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 11: BIT = ביט ללא מעקב ===
      if (desc.includes('bit') && !desc.includes('rabbit') && !desc.includes('habit')) {
        if (expense.category !== 'ביט ללא מעקב') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"ביט ללא מעקב"`);
          expense.category = 'ביט ללא מעקב';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 12: קפאין הולמס פלייס = אוכל בחוץ ===
      if (desc.includes('קפאין') || desc.includes('cafein')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 13: ספייס = חדר כושר ===
      if (desc.includes('ספייס') || desc.includes('space')) {
        if (expense.category !== 'חדר כושר') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"חדר כושר"`);
          expense.category = 'חדר כושר';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 14: ספרינט סונול = דלק וחניה ===
      if (desc.includes('ספרינט') || desc.includes('sprint')) {
        if (expense.category !== 'דלק וחניה') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"דלק וחניה"`);
          expense.category = 'דלק וחניה';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 15: סוויט ואלמה מרקט = אוכל בחוץ ===
      if (desc.includes('סוויט') || desc.includes('אלמה מרקט') || desc.includes('sweet')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 16: נונומימי = אוכל בחוץ ===
      if (desc.includes('נונומימי') || desc.includes('nonomimi')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 17: יאנגו דאלי = מזון לבית ===
      if (desc.includes('יאנגו דאלי') || desc.includes('yango deli') || desc.includes('yango daily')) {
        if (expense.category !== 'מזון לבית') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"מזון לבית"`);
          expense.category = 'מזון לבית';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 18: קיוסקים = מזון לבית ===
      if (desc.includes('קיוסק מילנה') || desc.includes('קיוסק העצמאות')) {
        if (expense.category !== 'מזון לבית') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"מזון לבית"`);
          expense.category = 'מזון לבית';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 19: גולדה והרב הרב = אוכל בחוץ ===
      if (desc.includes('גולדה') || desc.includes('golda') || desc.includes('הרב הרב') || desc.includes('hervherv')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 20: ארומה מנורה = אוכל בחוץ ===
      if (desc.includes('ארומה מנורה')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 21: חברת החשמל = הוצאות בית ===
      if (desc.includes('חברת החשמל') || desc.includes('חשמל לישראל')) {
        if (expense.category !== 'הוצאות בית') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"הוצאות בית"`);
          expense.category = 'הוצאות בית';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 22: הולמס פלייס = חדר כושר ===
      if (desc.includes('הולמס פלייס') || desc.includes('holmes place')) {
        if (expense.category !== 'חדר כושר') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"חדר כושר"`);
          expense.category = 'חדר כושר';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 23: פט בסט = בעלי חיים ===
      if (desc.includes('פט בסט') || desc.includes('פטבסט') || desc.includes('petbest') || desc.includes('pet best')) {
        if (expense.category !== 'בעלי חיים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"בעלי חיים"`);
          expense.category = 'בעלי חיים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 24: PAYBOX = ביט ללא מעקב ===
      if (desc.includes('paybox')) {
        if (expense.category !== 'ביט ללא מעקב') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"ביט ללא מעקב"`);
          expense.category = 'ביט ללא מעקב';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 25: חיסכון מפתח = חסכונות ===
      if (desc.includes('חיסכון מפתח')) {
        if (expense.category !== 'חסכונות') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"חסכונות"`);
          expense.category = 'חסכונות';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 26: מיסטר גרין = אוכל בחוץ ===
      if (desc.includes('מיסטר גרין') || desc.includes('mister green')) {
        if (expense.category !== 'אוכל בחוץ ובילויים') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"אוכל בחוץ ובילויים"`);
          expense.category = 'אוכל בחוץ ובילויים';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // === תיקון קריטי 27: NGO DELI = מזון לבית ===
      if (desc.includes('ngo deli')) {
        if (expense.category !== 'מזון לבית') {
          console.log(`🔧 תיקון: "${expense.description}" מ-"${expense.category}" ל-"מזון לבית"`);
          expense.category = 'מזון לבית';
          expense.auto_corrected = true;
        }
        return expense;
      }
      
      // תיקון 4: חברות ביטוח ידועות
      const insuranceCompanies = [
        'הראל', 'harel', 'מגדל', 'migdal', 'הפניקס', 'phoenix',
        'כלל', 'clal', 'מנורה', 'menora', 'איילון', 'ayalon'
      ];
      
      for (const company of insuranceCompanies) {
        if (desc.includes(company)) {
          if (expense.category !== 'ביטוח') {
            console.log(`🔧 תיקון אוטומטי: "${expense.description}" מ-"${expense.category}" ל-"ביטוח"`);
            expense.category = 'ביטוח';
            expense.auto_corrected = true;
          }
          break;
        }
      }
      
      // תיקון 5: שירותי בריאות
      if ((desc.includes('מכבידנט') || desc.includes('דנטל') || desc.includes('שיניים')) 
          && expense.category !== 'בריאות') {
        console.log(`🔧 תיקון אוטומטי: "${expense.description}" מ-"${expense.category}" ל-"בריאות"`);
        expense.category = 'בריאות';
        expense.auto_corrected = true;
      }
      
      // תיקון 6: גט = תחבורה
      if ((desc.includes('gett') || desc.includes('גט')) && expense.category !== 'תחבצ') {
        console.log(`🔧 תיקון אוטומטי: "${expense.description}" מ-"${expense.category}" ל-"תחבצ"`);
        expense.category = 'תחבצ';
        expense.auto_corrected = true;
      }
      
      // תיקון 8: זיהוי תשלומים שלא חולקו
      const installment = parseInstallment(expense.description, expense.amount);
      if (installment.isInstallment) {
        console.log(`🔧 חלוקה לתשלומים: "${expense.description}" → ${installment.monthly_amount}₪/חודש (${installment.installment_current}/${installment.installment_total})`);
        expense.amount = installment.monthly_amount;
        expense.installment_info = installment;
        expense.display_note = `תשלום ${installment.installment_current}/${installment.installment_total}`;
      }
      
      // וולידציה: סכום גבוה מחשיד
      if (expense.amount > 10000 && 
          !['משכנתא', 'מיסים', 'שכר דירה', 'קופת חולים'].includes(expense.category)) {
        console.warn(`⚠️ סכום חשוד: ${expense.description} - ${expense.amount}₪ בקטגוריה "${expense.category}"`);
        expense.needs_review = true;
      }
      
      return expense;
    }

    // עיבוד אחרי AI
    function postProcessCategories(expenses) {
      // #region agent log
      console.log(`🔄 postProcessCategories called with ${expenses.length} expenses`);
      // #endregion
      return expenses.map((exp, index) => {
        const originalCategory = exp.category;
        // קודם נסה מהמאגר
        const dbCategory = categorizeByDatabase(exp.description);
        if (dbCategory && dbCategory !== exp.category) {
          console.log(`🔧 תיקון ממאגר: "${exp.description}" מ-"${exp.category}" ל-"${dbCategory}"`);
          exp.category = dbCategory;
        } else if (dbCategory === null) {
          // #region agent log
          console.log(`⚠️ No DB match for: "${exp.description}" - keeping AI category: "${exp.category}"`);
          // #endregion
        }
        
        // אחר כך תיקון אוטומטי ווולידציה
        const result = autoCorrectAndValidate(exp);
        // #region agent log
        if (result.category !== originalCategory) {
          console.log(`🔀 Category changed: "${result.description}" from "${originalCategory}" to "${result.category}"`);
        }
        // #endregion
        return result;
      });
    }

    // Credit cards data
    let cardFiles = {};
    let cardCount = 1;
    let bankFile = null;
    let bankData = null;

    function addCardSlot() {
      cardCount++;
      const currentCardNum = cardCount; // שמירת הערך הנוכחי למניעת בעיית closure
      console.log(`➕ Adding card slot ${currentCardNum}`);
      
      const grid = document.getElementById('creditCardsGrid');
      const addBtn = grid.querySelector('.add-card-btn');
      
      const newCard = document.createElement('div');
      newCard.className = 'upload-box';
      newCard.id = `cardBox${currentCardNum}`;
      newCard.onclick = function() { 
        console.log(`🖱️ Click on card ${currentCardNum}`);
        document.getElementById(`cardInput${currentCardNum}`).click(); 
      };
      newCard.innerHTML = `
        <div class="icon" id="cardIcon${currentCardNum}">📄</div>
        <h4 id="cardTitle${currentCardNum}">כרטיס אשראי ${currentCardNum}</h4>
        <p id="cardDesc${currentCardNum}">לחץ לבחירת קובץ</p>
        <input type="file" id="cardInput${currentCardNum}" accept=".xlsx,.xls,.csv" onchange="handleCardFile(${currentCardNum}, this)">
      `;
      
      grid.insertBefore(newCard, addBtn);
    }

    async function handleCardFile(cardNum, input) {
      console.log(`📁 handleCardFile called for card ${cardNum}`);
      const file = input.files[0];
      if (!file) {
        console.log('❌ No file selected');
          return;
        }

      console.log(`📄 File selected: ${file.name}, size: ${file.size} bytes`);
      
      try {
        const data = await readExcelFile(file);
        console.log(`✅ File read successfully: ${data.length} rows`);
        
        cardFiles[cardNum] = {
          name: file.name,
          data: data
        };
        
        document.getElementById(`cardIcon${cardNum}`).textContent = '✅';
        document.getElementById(`cardTitle${cardNum}`).textContent = file.name.substring(0, 20);
        document.getElementById(`cardDesc${cardNum}`).textContent = `${data.length} שורות`;
        document.getElementById(`cardBox${cardNum}`).classList.add('has-file');
        
        showSuccess(`✅ קובץ "${file.name}" נטען בהצלחה - ${data.length} שורות`);
        checkReadyToAnalyze();
      } catch (error) {
        console.error('❌ Error reading file:', error);
        showError('שגיאה בקריאת הקובץ: ' + error.message);
      }
    }

    async function handleBankFile(input) {
      console.log('📁 handleBankFile called');
      const file = input.files[0];
      if (!file) {
        console.log('❌ No bank file selected');
        return;
      }
      
      console.log(`📄 Bank file selected: ${file.name}, size: ${file.size} bytes`);
      
      try {
        const data = await readExcelFile(file);
        console.log(`✅ Bank file read successfully: ${data.length} rows`);
        
        bankFile = file;
        bankData = data;
        
        document.getElementById('bankIcon').textContent = '✅';
        document.getElementById('bankTitle').textContent = file.name.substring(0, 20);
        document.getElementById('bankDesc').textContent = `${data.length} שורות`;
        document.getElementById('bankBox').classList.add('has-file');
        
        showSuccess(`✅ קובץ עו"ש "${file.name}" נטען בהצלחה - ${data.length} שורות`);
        checkReadyToAnalyze();
      } catch (error) {
        console.error('❌ Error reading bank file:', error);
        showError('שגיאה בקריאת הקובץ: ' + error.message);
      }
    }

    async function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            resolve(jsonData);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function checkReadyToAnalyze() {
      const hasCards = Object.keys(cardFiles).length > 0;
      const hasBank = bankData !== null;
      document.getElementById('analyzeBtn').disabled = !(hasCards || hasBank);
    }

    // === פרסור חכם של אקסל - זיהוי עמודות ===
    function detectColumns(headerRow) {
      const columns = {
        description: -1,       // שם בית עסק
        transactionAmount: -1, // סכום עסקה (סה"כ - לא להשתמש!)
        chargeAmount: -1,      // סכום חיוב (חודשי - להשתמש בזה!)
        transactionType: -1,   // סוג עסקה
        notes: -1,             // הערות
        category: -1           // ענף
      };
      
      // מעבר ראשון - זיהוי כל העמודות
      headerRow.forEach((cell, index) => {
        const cellText = String(cell || '').trim().toLowerCase();
        const originalText = String(cell || '').trim();
        
        // שם בית עסק - וריאציות שונות
        if (originalText.includes('שם בית עסק') || originalText.includes('שם בית העסק') || 
            originalText.includes('בית עסק') || originalText.includes('תיאור') || 
            originalText.includes('פרטים') || originalText.includes('שם העסק')) {
          if (columns.description === -1) columns.description = index;
        }
        
        // סכום חיוב (חודשי) - עדיפות ראשונה - וריאציות רבות
        if (originalText.includes('סכום חיוב') || 
            originalText.includes('סה"כ לחיוב') || 
            originalText.includes('סהכ לחיוב') ||
            originalText.includes('לחיוב בש') ||
            originalText.includes('סכום בש"ח') ||
            originalText.includes('סכום בשח') ||
            (originalText.includes('חיוב') && !originalText.includes('תאריך') && !originalText.includes('מועד'))) {
          columns.chargeAmount = index;
        }
        // סכום עסקה (כולל) - עדיפות שניה
        else if (originalText.includes('סכום עסקה') || originalText.includes('סכום העסקה')) {
          columns.transactionAmount = index;
        }
        
        if (originalText.includes('סוג עסקה') || (originalText.includes('סוג') && !originalText.includes('מטבע'))) {
          columns.transactionType = index;
        }
        if (originalText.includes('הערות') || originalText.includes('הערה') || originalText.includes('פירוט')) {
          columns.notes = index;
        }
        if (originalText.includes('ענף') || originalText.includes('קטגוריה')) {
          columns.category = index;
        }
      });
      
      // מעבר שני - אם לא מצאנו סכום חיוב, נחפש סכום גנרי
      if (columns.chargeAmount === -1 && columns.transactionAmount === -1) {
        headerRow.forEach((cell, index) => {
          const originalText = String(cell || '').trim();
          // סכום גנרי - רק אם לא מצאנו שום סכום קודם
          if ((originalText.includes('סכום') || originalText.includes('₪') || originalText.includes('ש"ח')) && 
              columns.chargeAmount === -1 && 
              !originalText.includes('תאריך') && !originalText.includes('מועד')) {
            columns.chargeAmount = index;
          }
        });
      }
      
      console.log('🔍 Detected columns:', columns, 'from header:', headerRow);
      return columns;
    }

    // === חילוץ מידע על תשלומים מעמודת הערות (דוח מיפוי) ===
    function extractInstallmentInfoFromNotes(notes) {
      if (!notes) return null;
      const notesStr = String(notes).trim();
      
      // "תשלום X מתוך Y"
      let m = notesStr.match(/תשלום\s*(\d+)\s*מתוך\s*(\d+)/);
      if (m) return { current: parseInt(m[1]), total: parseInt(m[2]) };
      
      // "חלק X מתוך Y"
      m = notesStr.match(/חלק\s*(\d+)\s*מתוך\s*(\d+)/i);
      if (m) return { current: parseInt(m[1]), total: parseInt(m[2]) };
      
      // "X מתוך Y תשלומים"
      m = notesStr.match(/(\d+)\s*מתוך\s*(\d+)\s*תשלומים/);
      if (m) return { current: parseInt(m[1]), total: parseInt(m[2]) };
      
      // "תשלום X/Y" או "X/Y" (בהערות)
      m = notesStr.match(/תשלום\s*(\d+)\s*[\/\-]\s*(\d+)/i) || notesStr.match(/(\d+)\s*[\/\-]\s*(\d+)\s*תשלום/);
      if (m) return { current: parseInt(m[1]), total: parseInt(m[2]) };
      
      // "הסכום יחולק ל-X תשלומים" או "ל-X תשלומים"
      m = notesStr.match(/יחולק\s*ל[־-]?\s*(\d+)\s*תשלומים/) || notesStr.match(/ל[־-]?\s*(\d+)\s*תשלומים/);
      if (m) return { current: 1, total: parseInt(m[1]) };
      
      // "פריסה ל-X תשלומים"
      m = notesStr.match(/פריסה\s*ל[־-]?\s*(\d+)\s*תשלומים/i);
      if (m) return { current: 1, total: parseInt(m[1]) };
      
      return null;
    }

    // === זיהוי עמודות לפי תוכן (ללא כותרות) ===
    function detectColumnsByContent(data) {
      console.log('🔍 Trying to detect columns by content analysis...');
      
      const sampleRows = data.slice(0, Math.min(20, data.length)).filter(row => row && row.length > 0);
      if (sampleRows.length === 0) return null;
      
      const numCols = Math.max(...sampleRows.map(r => r.length));
      const columnTypes = [];
      
      for (let col = 0; col < numCols; col++) {
        let textCount = 0;
        let numberCount = 0;
        let dateCount = 0;
        let dateSerialCount = 0;   // Excel serial dates 30000-60000
        let referenceNumberCount = 0; // 9+ digit integers
        let hebrewTextCount = 0;
        let currencyCount = 0;
        let sumValues = 0;
        let decimalCount = 0;
        
        for (const row of sampleRows) {
          const val = row[col];
          if (val === null || val === undefined || val === '') continue;
          
          // Date object from cellDates: true
          if (typeof val === 'object' && val instanceof Date) {
            dateCount++;
            continue;
          }
          
          const strVal = String(val).trim();
          
          // תאריך כמחרוזת
          if (/^\d{1,2}[./-]\d{1,2}[./-]\d{2,4}$/.test(strVal)) {
            dateCount++;
            continue;
          }
          
          // סימן מטבע
          if (strVal === '₪' || strVal === '$' || strVal === 'ש"ח') {
            currencyCount++;
            continue;
          }
          
          // מספר
          const numVal = typeof val === 'number' ? val : parseFloat(strVal.replace(/,/g, ''));
          if (!isNaN(numVal) && strVal.match(/^[\d,.-]+$/)) {
            const absVal = Math.abs(numVal);
            const isInteger = Number.isInteger(numVal) || !strVal.includes('.');
            
            // Excel serial date (כרטיסי אשראי בד"כ 2024-2026 = ~45000-46000)
            if (absVal >= 30000 && absVal <= 60000 && isInteger) {
              dateSerialCount++;
              dateCount++;
              continue;
            }
            // מספר אסמכתא (9+ ספרות)
            if (absVal >= 100000000 || (isInteger && strVal.replace(/[^0-9]/g, '').length >= 9)) {
              referenceNumberCount++;
              continue;
            }
            
            numberCount++;
            sumValues += absVal;
            if (strVal.includes('.') && absVal < 100000) {
              decimalCount++;
            }
            continue;
          }
          
          // טקסט עברי (שם בית עסק)
          if (/[\u0590-\u05FF]/.test(strVal) && strVal.length > 3) {
            hebrewTextCount++;
            textCount++;
          } else if (strVal.length > 2) {
            textCount++;
          }
        }
        
        const avgValue = numberCount > 0 ? sumValues / numberCount : 0;
        
        // עמודה עם הרבה serial dates לא מתאימה לסכום
        const effectiveNumberCount = numberCount;
        
        columnTypes.push({
          col,
          textCount,
          numberCount: effectiveNumberCount,
          dateCount,
          dateSerialCount,
          referenceNumberCount,
          hebrewTextCount,
          currencyCount,
          decimalCount,
          avgValue,
          total: sampleRows.length
        });
      }
      
      // זיהוי עמודות עם סימן מטבע (לצורך בונוס סמוך)
      const currencyCols = new Set(columnTypes.filter(ct => ct.currencyCount > ct.total * 0.3).map(ct => ct.col));
      
      console.log('📊 Column analysis:', columnTypes);
      
      // עמודת תיאור = הכי הרבה טקסט עברי
      let descriptionCol = -1;
      let maxHebrewText = 0;
      for (const ct of columnTypes) {
        if (ct.hebrewTextCount > maxHebrewText) {
          maxHebrewText = ct.hebrewTextCount;
          descriptionCol = ct.col;
        }
      }
      
      // עמודת סכום
      let amountCol = -1;
      let bestAmountScore = 0;
      
      for (const ct of columnTypes) {
        if (ct.col === descriptionCol) continue;
        if (ct.numberCount < ct.total * 0.25) continue;
        
        // לא עמודת תאריכים (כולל Excel serial)
        if (ct.dateCount > ct.total * 0.4 || ct.dateSerialCount > ct.total * 0.3) {
          console.log(`⏭️ Skipping col ${ct.col} - date/serial column`);
          continue;
        }
        
        // לא מספרי אסמכתא
        if (ct.referenceNumberCount > ct.total * 0.5) {
          console.log(`⏭️ Skipping col ${ct.col} - reference numbers`);
          continue;
        }
        if (ct.avgValue > 100000) {
          console.log(`⏭️ Skipping col ${ct.col} - avg too high (${ct.avgValue.toFixed(0)})`);
          continue;
        }
        
        let score = ct.numberCount;
        if (ct.decimalCount > ct.total * 0.2) score *= 3;
        if (ct.avgValue > 1 && ct.avgValue < 10000) score *= 2;
        
        // בונוס אם עמודה סמוכה לסימן מטבע
        if (currencyCols.has(ct.col - 1) || currencyCols.has(ct.col + 1)) score *= 1.5;
        
        const distance = Math.abs(ct.col - descriptionCol);
        score = score / (distance * 0.5 + 1);
        
        console.log(`📊 Col ${ct.col}: score=${score.toFixed(1)}, avg=${ct.avgValue.toFixed(1)}, decimals=${ct.decimalCount}`);
        
        if (score > bestAmountScore) {
          bestAmountScore = score;
          amountCol = ct.col;
        }
      }
      
      if (descriptionCol === -1 || amountCol === -1) {
        console.log('⚠️ Could not detect columns by content');
        return null;
      }
      
      console.log(`✅ Detected by content: description=${descriptionCol}, amount=${amountCol}`);
      return { description: descriptionCol, amount: amountCol };
    }

    // === זיהוי פורמטים מוכרים (כרטיסי אשראי ישראליים) ===
    function detectKnownFormat(data) {
      const scanRows = data.slice(0, Math.min(15, data.length)).filter(row => row && row.length > 0);
      if (scanRows.length === 0) return null;

      // Leumi Card / Max / Isracard: שורה עם "שם בית עסק" + "סכום חיוב"
      const descHeaders = ['שם בית העסק', 'שם בית עסק'];
      const amountHeaders = ['סכום חיוב', 'סכום חיוב ₪', 'סכום'];

      for (let r = 0; r < scanRows.length; r++) {
        const row = scanRows[r];
        let descCol = -1;
        let amountCol = -1;
        for (let c = 0; c < row.length; c++) {
          const cell = String(row[c] || '').trim();
          if (descHeaders.some(h => cell.includes(h))) descCol = c;
          if (amountHeaders.some(h => cell.includes(h))) amountCol = c;
        }
        if (descCol !== -1 && amountCol !== -1) {
          console.log('✅ Known format detected (Leumi/Max/Isracard) at row', r, { description: descCol, amount: amountCol });
          return { description: descCol, amount: amountCol };
        }
      }

      // CAL: שורה שמתחילה ב"העסקה" – מיקומים קבועים
      for (let r = 0; r < scanRows.length; r++) {
        const row = scanRows[r];
        const first = String(row[0] || '').trim();
        if (first.includes('העסקה')) {
          // CAL: שם עסק לרוב בעמודה 1, סכום בעמודה 4 (מתאים לדוחות CAL נפוצים)
          const descCol = 1;
          const amountCol = row.length > 4 ? 4 : (row.length > 2 ? row.length - 1 : -1);
          if (amountCol >= 0) {
            console.log('✅ Known format detected (CAL) at row', r, { description: descCol, amount: amountCol });
            return { description: descCol, amount: amountCol };
          }
        }
      }

      return null;
    }

    // === פונקציה ישנה לגיבוי - משופרת ===
    function oldFormatDataForAI(data, cardName) {
      console.log('🔄 oldFormatDataForAI called, trying content detection first...');
      
      // ננסה לזהות עמודות לפי תוכן
      const detectedCols = detectColumnsByContent(data);
      
      if (detectedCols) {
        // מצאנו עמודות - נעבד את הנתונים בצורה מסודרת
        let text = `דוח הוצאות - ${cardName}\n`;
        text += '='.repeat(50) + '\n';
        text += 'הסכומים הם חודשיים\n';
        text += '='.repeat(50) + '\n';
        
        let processedCount = 0;
        for (const row of data) {
          if (!row || row.length === 0) continue;
          
          const description = row[detectedCols.description];
          const amount = row[detectedCols.amount];
          
          // דלג על שורות סיכום
          if (description && String(description).includes('סה"כ')) continue;
          
          if (description && amount !== null && amount !== undefined) {
            const numAmount = typeof amount === 'number' ? amount : parseFloat(String(amount).replace(/,/g, ''));
            if (!isNaN(numAmount) && numAmount !== 0) {
              text += `${description} | ${numAmount}\n`;
              processedCount++;
            }
          }
        }
        
        console.log(`✅ Processed ${processedCount} rows with content detection`);
        if (processedCount > 0) {
          return text;
        }
      }
      
      // אם לא הצלחנו - נשתמש בפורמט הגולמי
      console.log('⚠️ Falling back to raw format');
      let text = `דוח הוצאות - ${cardName}\n`;
      text += '='.repeat(50) + '\n';
      
      for (const row of data) {
        if (row && row.length > 0) {
          const rowText = row.filter(cell => cell !== null && cell !== undefined).join(' | ');
          if (rowText.trim()) {
            text += rowText + '\n';
          }
        }
      }
      
      return text;
    }

    // === פרסור חכם - לוקח סכום חיוב ולא סכום עסקה ===
    function formatDataForAI(data, cardName) {
      console.log('🔄 Smart formatDataForAI called for:', cardName);
      console.log('📊 Data preview (first 5 rows):', data.slice(0, 5));
      
      // ניסיון ראשון: פורמט מוכר (כרטיסי אשראי), אחר כך זיהוי לפי תוכן
      const contentCols = detectKnownFormat(data) || detectColumnsByContent(data);
      if (contentCols) {
        console.log('✅ Using detected columns (known format or content)');
        let text = `דוח הוצאות - ${cardName}\n`;
        text += '='.repeat(50) + '\n';
        text += 'הסכומים הם חודשיים\n';
        text += '='.repeat(50) + '\n';
        
        let processedCount = 0;
        for (const row of data) {
          if (!row || row.length === 0) continue;
          
          const description = row[contentCols.description];
          const amount = row[contentCols.amount];
          
          // דלג על שורות סיכום
          if (description && String(description).includes('סה"כ')) continue;
          
          if (description && amount !== null && amount !== undefined) {
            const numAmount = typeof amount === 'number' ? amount : parseFloat(String(amount).replace(/,/g, ''));
            if (!isNaN(numAmount) && numAmount !== 0) {
              text += `${description} | ${numAmount}\n`;
              processedCount++;
            }
          }
        }
        
        if (processedCount > 0) {
          console.log(`✅ Processed ${processedCount} rows with content detection`);
          console.log('📝 Text sample:', text.substring(0, 500));
          return text;
        }
      }
      
      // מצא את שורת הכותרות - חיפוש מורחב
      let headerRowIndex = -1;
      let columns = null;
      
      // מילות מפתח לזיהוי שורת כותרות
      const headerKeywords = ['שם בית עסק', 'שם בית העסק', 'בית עסק', 'תיאור', 'פרטים', 'שם העסק'];
      
      for (let i = 0; i < Math.min(15, data.length); i++) {
        const row = data[i];
        if (!row) continue;
        
        const rowText = row.map(cell => String(cell || '')).join(' ');
        if (headerKeywords.some(keyword => rowText.includes(keyword))) {
          headerRowIndex = i;
          columns = detectColumns(row);
          console.log(`📋 Header found at row ${i}:`, row);
          break;
        }
      }
      
      // אם לא מצאנו כותרות - חזור לפונקציה הישנה
      if (!columns || columns.description === -1) {
        console.log('⚠️ Could not detect columns, using old formatter');
        return oldFormatDataForAI(data, cardName);
      }
      
      // אם לא מצאנו עמודת סכום - ננסה לזהות לפי מיקום (עמודות אחרונות בד"כ מכילות סכומים)
      if (columns.chargeAmount === -1 && columns.transactionAmount === -1) {
        console.log('⚠️ No amount column found by header, trying to find numeric column...');
        
        // נחפש עמודה עם ערכים מספריים
        const firstDataRow = data[headerRowIndex + 1];
        if (firstDataRow) {
          for (let col = firstDataRow.length - 1; col >= 0; col--) {
            const val = firstDataRow[col];
            if (val !== null && val !== undefined && val !== '') {
              const numVal = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
              if (!isNaN(numVal) && numVal > 0 && col !== columns.description) {
                columns.chargeAmount = col;
                console.log(`📍 Found numeric column at index ${col} with value ${numVal}`);
                break;
              }
            }
          }
        }
      }
      
      // אם עדיין לא מצאנו סכום - חזור לפונקציה הישנה
      if (columns.chargeAmount === -1 && columns.transactionAmount === -1) {
        console.log('⚠️ Still no amount column found, using old formatter');
        return oldFormatDataForAI(data, cardName);
      }
      
      console.log('✅ Final columns detected:', columns);
      
      let text = `דוח הוצאות - ${cardName}\n`;
      text += '='.repeat(50) + '\n';
      text += 'הסכומים הם חודשיים (לא סה"כ העסקה)\n';
      text += '='.repeat(50) + '\n';
      
      let processedCount = 0;
      let skippedCount = 0;
      let zeroAmountCount = 0;
      
      for (let i = headerRowIndex + 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length === 0) continue;
        
        const description = row[columns.description];
        const transactionType = columns.transactionType !== -1 ? row[columns.transactionType] : '';
        const notes = columns.notes !== -1 ? row[columns.notes] : '';
        
        // דלג על שורות "רכישה בתשלומים" - התשלומים הבודדים נספרים בנפרד
        if (transactionType && String(transactionType).includes('רכישה בתשלומים')) {
          console.log(`⏭️ Skipping installment purchase row: ${description}`);
          skippedCount++;
          continue;
        }
        
        // השתמש בסכום חיוב (חודשי), לא בסכום עסקה (כולל)
        let amount = null;
        if (columns.chargeAmount !== -1 && row[columns.chargeAmount] !== undefined && row[columns.chargeAmount] !== null && row[columns.chargeAmount] !== '') {
          amount = row[columns.chargeAmount];
        } else if (columns.transactionAmount !== -1 && row[columns.transactionAmount] !== undefined && row[columns.transactionAmount] !== null && row[columns.transactionAmount] !== '') {
          amount = row[columns.transactionAmount];
        }
        
        // אם הסכום הוא 0 או ריק, ננסה למצוא סכום בעמודות אחרות
        if ((amount === null || amount === undefined || amount === '' || amount === 0) && description) {
          for (let col = 0; col < row.length; col++) {
            if (col === columns.description) continue;
            const val = row[col];
            if (val !== null && val !== undefined && val !== '') {
              const numVal = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
              if (!isNaN(numVal) && numVal > 0) {
                amount = numVal;
                console.log(`💰 Found amount ${amount} in column ${col} for "${description}"`);
                break;
              }
            }
          }
        }
        
        if (!description || amount === null || amount === undefined) continue;
        
        // ספירת סכומים אפסיים לדיבאג
        if (amount === 0 || amount === '0') {
          zeroAmountCount++;
          console.log(`⚠️ Zero amount for: ${description}, row:`, row);
        }
        
        // חלץ מידע על תשלומים: קודם מהערות, אחר כך מתיאור (דוח מיפוי)
        let installment = extractInstallmentInfoFromNotes(notes);
        if (!installment) {
          const numAmount = typeof amount === 'number' ? amount : parseFloat(String(amount).replace(/,/g, '')) || 0;
          const parsed = parseInstallment(String(description), numAmount);
          if (parsed.isInstallment) {
            installment = { current: parsed.installment_current, total: parsed.installment_total };
          }
        }
        let installmentNote = '';
        if (installment) {
          installmentNote = ` (תשלום ${installment.current}/${installment.total})`;
        }
        
        // הוסף את הענף אם קיים
        const category = columns.category !== -1 ? row[columns.category] : '';
        const categoryNote = category ? ` [${category}]` : '';
        
        text += `${description} | ${amount}${installmentNote}${categoryNote}\n`;
        processedCount++;
      }
      
      console.log(`✅ Processed ${processedCount} rows, skipped ${skippedCount} installment purchase rows, ${zeroAmountCount} zero amounts`);
      
      // אם יותר מדי סכומים אפסיים - כנראה יש בעיה בזיהוי העמודות
      if (zeroAmountCount > processedCount * 0.5 && processedCount > 5) {
        console.log('⚠️ Too many zero amounts, something is wrong with column detection. Using old formatter.');
        return oldFormatDataForAI(data, cardName);
      }
      
      // אם לא עובדו שורות - חזור לפונקציה הישנה
      if (processedCount === 0) {
        console.log('⚠️ No rows processed by smart parser, falling back to old formatter');
        return oldFormatDataForAI(data, cardName);
      }
      
      console.log('📝 Text preview (first 500 chars):', text.substring(0, 500));
      return text;
    }

    function formatBankDataForAI(data) {
      // סינון מקדים של שורות לא רלוונטיות
      const ignorePatterns = [
        'מקס', 'max', 'ישראכרט', 'כאל', 'לאומי קארד', 'דיינרס', // כרטיסי אשראי
        'קניה/', 'מכירה/', 'אלטשולר', 'מגדל', 'אקסלנס', 'מיטב', // השקעות
        'ריבית זכות', 'מילואים', 'משכורת', 'זיכוי', // הכנסות
        'קיזוז מטח', 'מט"ח', 'המרה', // המרות
        'מס בגין', 'תנועת מס', // מיסים על רווחים
        'יתרה', 'סה"כ', 'סיכום' // יתרות
      ];
      
      let text = `דוח תנועות עו"ש\n`;
      text += '='.repeat(50) + '\n';
      
      for (const row of data) {
        if (row && row.length > 0) {
          const rowText = row.filter(cell => cell !== null && cell !== undefined).join(' | ');
          const lowerRow = rowText.toLowerCase();
          
          // דלג על שורות שמכילות מילות מפתח להתעלמות
          const shouldIgnore = ignorePatterns.some(pattern => 
            lowerRow.includes(pattern.toLowerCase())
          );
          
          if (rowText.trim() && !shouldIgnore) {
            text += rowText + '\n';
          }
        }
      }
      
      return text;
    }

    async function analyzeAllCards() {
      hideError();
      showLoading('מנתח את הדוחות...', 'שלב 1 מתוך ' + (Object.keys(cardFiles).length + (bankData ? 1 : 0)));

      const allResults = { cards: [], bank: null };

      try {
        // ניתוח כרטיסי אשראי
        let step = 1;
        for (const [cardNum, cardInfo] of Object.entries(cardFiles)) {
          document.getElementById('loadingSubtext').textContent = `מנתח כרטיס ${step}...`;
          
          const text = formatDataForAI(cardInfo.data, cardInfo.name);
          
        const response = await fetch('/api/analyze', {
          method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text.substring(0, 20000) })
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'שגיאה בניתוח');
          }

        const data = await response.json();
          
          // עיבוד אחרי AI
          const processedExpenses = postProcessCategories(data.expenses || []);
          
          allResults.cards.push({
            name: cardInfo.name.replace(/\.[^.]+$/, ''),
            expenses: processedExpenses
          });
          
          step++;
        }

        // ניתוח עו"ש
        if (bankData) {
          document.getElementById('loadingSubtext').textContent = 'מנתח חשבון עו"ש...';
          
          const bankText = formatBankDataForAI(bankData);
          
          const response = await fetch('/api/analyze-bank', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              text: bankText.substring(0, 20000),
              bankName: bankFile.name.replace(/\.[^.]+$/, '')
            })
          });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'שגיאה בניתוח עו"ש');
          }

          const bankResult = await response.json();
          
          // עיבוד אחרי AI
          const processedBankExpenses = postProcessCategories(bankResult.expenses || []);
          
          allResults.bank = {
            name: bankFile.name.replace(/\.[^.]+$/, ''),
            expenses: processedBankExpenses
          };
        }

        // שמירה ומעבר לדוח
        localStorage.setItem('expenseResults', JSON.stringify(allResults));
        window.location.href = 'report.html';

      } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showError('שגיאה: ' + error.message);
      }
    }

    function showLoading(text, subtext) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingSubtext').textContent = subtext;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.classList.add('active');
    }

    function hideError() {
      document.getElementById('errorMessage').classList.remove('active');
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.classList.add('active');
    }
  </script>
</body>
</html>
